

<!DOCTYPE html>


<html lang="en" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.18.1: http://docutils.sourceforge.net/" />

    <title>6.13. Testing &#8212; Effective Python for Data Scientists</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "light";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="../_static/styles/theme.css?digest=c5ced968eda925caa686" rel="stylesheet" />
<link href="../_static/styles/bootstrap.css?digest=c5ced968eda925caa686" rel="stylesheet" />
<link href="../_static/styles/pydata-sphinx-theme.css?digest=c5ced968eda925caa686" rel="stylesheet" />

  
  <link href="../_static/vendor/fontawesome/6.1.2/css/all.min.css?digest=c5ced968eda925caa686" rel="stylesheet" />
  <link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.1.2/webfonts/fa-solid-900.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.1.2/webfonts/fa-brands-400.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.1.2/webfonts/fa-regular-400.woff2" />

    <link rel="stylesheet" type="text/css" href="../_static/pygments.css" />
    <link rel="stylesheet" href="../_static/styles/sphinx-book-theme.css?digest=14f4ca6b54d191a8c7657f6c759bf11a5fb86285" type="text/css" />
    <link rel="stylesheet" type="text/css" href="../_static/togglebutton.css" />
    <link rel="stylesheet" type="text/css" href="../_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="../_static/mystnb.4510f1fc1dee50b3e5859aac5469c37c29e427902b24a333a5f9fcb2f0b3ac41.css" />
    <link rel="stylesheet" type="text/css" href="../_static/sphinx-thebe.css" />
    <link rel="stylesheet" type="text/css" href="../_static/design-style.4045f2051d55cab465a707391d5b2007.min.css" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../_static/scripts/bootstrap.js?digest=c5ced968eda925caa686" />
<link rel="preload" as="script" href="../_static/scripts/pydata-sphinx-theme.js?digest=c5ced968eda925caa686" />
  <script src="../_static/vendor/fontawesome/6.1.2/js/all.min.js?digest=c5ced968eda925caa686"></script>

    <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
    <script src="../_static/jquery.js"></script>
    <script src="../_static/underscore.js"></script>
    <script src="../_static/_sphinx_javascript_frameworks_compat.js"></script>
    <script src="../_static/doctools.js"></script>
    <script src="../_static/clipboard.min.js"></script>
    <script src="../_static/copybutton.js"></script>
    <script src="../_static/scripts/sphinx-book-theme.js?digest=5a5c038af52cf7bc1a1ec88eea08e6366ee68824"></script>
    <script>let toggleHintShow = 'Click to show';</script>
    <script>let toggleHintHide = 'Click to hide';</script>
    <script>let toggleOpenOnPrint = 'true';</script>
    <script src="../_static/togglebutton.js"></script>
    <script kind="utterances">

    var commentsRunWhenDOMLoaded = cb => {
    if (document.readyState != 'loading') {
        cb()
    } else if (document.addEventListener) {
        document.addEventListener('DOMContentLoaded', cb)
    } else {
        document.attachEvent('onreadystatechange', function() {
        if (document.readyState == 'complete') cb()
        })
    }
}

var addUtterances = () => {
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src = "https://utteranc.es/client.js";
    script.async = "async";

    script.setAttribute("repo", "khuyentran1401/Efficient_Python_tricks_and_tools_for_data_scientists");
    script.setAttribute("issue-term", "pathname");
    script.setAttribute("theme", "github-light");
    script.setAttribute("label", "💬 comment");
    script.setAttribute("crossorigin", "anonymous");

    sections = document.querySelectorAll("div.section");
    if (sections !== null) {
        section = sections[sections.length-1];
        section.appendChild(script);
    }
}
commentsRunWhenDOMLoaded(addUtterances);
</script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script src="../_static/design-tabs.js"></script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"
const thebe_selector = ".thebe,.cell"
const thebe_selector_input = "pre"
const thebe_selector_output = ".output, .cell_output"
</script>
    <script async="async" src="../_static/sphinx-thebe.js"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'Chapter5/testing';</script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="6.14. SQL Libraries" href="SQL.html" />
    <link rel="prev" title="6.12. Better Pandas" href="better_pandas.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <a class="skip-link" href="#main-content">Skip to main content</a>
  
  <div id="pst-scroll-pixel-helper"></div>

  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>
    Back to top
  </button>

  
  <input type="checkbox"
          class="sidebar-toggle"
          name="__primary"
          id="__primary"/>
  <label class="overlay overlay-primary" for="__primary"></label>
  
  <input type="checkbox"
          class="sidebar-toggle"
          name="__secondary"
          id="__secondary"/>
  <label class="overlay overlay-secondary" for="__secondary"></label>
  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
<form class="bd-search d-flex align-items-center"
      action="../search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search this book..."
         aria-label="Search this book..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
  </div>
  
    <nav class="bd-header navbar navbar-expand-lg bd-navbar">
    </nav>
  
  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      <div class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
    
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">
  

<a class="navbar-brand logo" href="../README.html">
  
  
  
  
  
    
    
      
    
    
    <img src="../_static/data_simplified_icon.png" class="logo__image only-light" alt="Effective Python for Data Scientists - Home"/>
    <script>document.write(`<img src="../_static/data_simplified_icon.png" class="logo__image only-dark" alt="Effective Python for Data Scientists - Home"/>`);</script>
  
  
</a></div>
        <div class="sidebar-primary-item"><nav class="bd-links" id="bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item navbar-nav active">
        
        <ul class="nav bd-sidenav bd-sidenav__home-link">
            <li class="toctree-l1">
                <a class="reference internal" href="../README.html">
                    What Should You Expect From This Book?
                </a>
            </li>
        </ul>
        <ul class="current nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../how_to_read.html">1. How to Read This Book</a></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../Chapter1/Chapter1.html">2. Python Built-in Methods</a><input class="toctree-checkbox" id="toctree-checkbox-1" name="toctree-checkbox-1" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-1"><i class="fa-solid fa-chevron-down"></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../Chapter1/string.html">2.1. String</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Chapter1/number.html">2.2. Number</a></li>
<li class="toctree-l2 has-children"><a class="reference internal" href="../Chapter1/list/list.html">2.3. List</a><input class="toctree-checkbox" id="toctree-checkbox-2" name="toctree-checkbox-2" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-2"><i class="fa-solid fa-chevron-down"></i></label><ul>
<li class="toctree-l3"><a class="reference internal" href="../Chapter1/list/get_elements.html">2.3.1. Get Elements</a></li>
<li class="toctree-l3"><a class="reference internal" href="../Chapter1/list/unpack_iterables.html">2.3.2. Unpack Iterables</a></li>
<li class="toctree-l3"><a class="reference internal" href="../Chapter1/list/join_iterable.html">2.3.3. Join Iterables</a></li>
<li class="toctree-l3"><a class="reference internal" href="../Chapter1/list/interaction_between_2_lists.html">2.3.4. Interaction Between 2 Lists</a></li>
<li class="toctree-l3"><a class="reference internal" href="../Chapter1/list/apply_functions_to_elements.html">2.3.5. Apply Functions to Elements in a List</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../Chapter1/dictionary.html">2.4. Dictionary</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Chapter1/function.html">2.5. Function</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Chapter1/class.html">2.6. Classes</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Chapter1/datetime.html">2.7. Datetime</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Chapter1/code_speed.html">2.8. Code Speed</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Chapter1/good_practices.html">2.9. Good Python Practices</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Chapter1/python_new_features.html">2.10. New Features in Python</a></li>
</ul>
</li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../Chapter2/Chapter2.html">3. Python Utility Libraries</a><input class="toctree-checkbox" id="toctree-checkbox-3" name="toctree-checkbox-3" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-3"><i class="fa-solid fa-chevron-down"></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../Chapter2/collections.html">3.1. Collections</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Chapter2/itertools.html">3.2. Itertools</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Chapter2/functools.html">3.3. Functools</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Chapter2/pydash.html">3.4. Pydash</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Chapter2/sympy.html">3.5. SymPy</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Chapter2/operator.html">3.6. Operator</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Chapter2/dataclasses.html">3.7. Data Classes</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Chapter2/typing.html">3.8. Typing</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Chapter2/pathlib.html">3.9. pathlib</a></li>
</ul>
</li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../Chapter3/Chapter3.html">4. Pandas</a><input class="toctree-checkbox" id="toctree-checkbox-4" name="toctree-checkbox-4" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-4"><i class="fa-solid fa-chevron-down"></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../Chapter3/change_values.html">4.1. Change Values</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Chapter3/get_values.html">4.2. Get Certain Values From a DataFrame</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Chapter3/date_time.html">4.3. Work with Datetime</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Chapter3/transform_dataframe.html">4.4. Transform a DataFrame</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Chapter3/create_dataframe.html">4.5. Create a DataFrame</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Chapter3/combine_dataframes.html">4.6. Combine Multiple DataFrames</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Chapter3/filter.html">4.7. Filter Rows or Columns</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Chapter3/data_types.html">4.8. Manipulate a DataFrame Using Data Types</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Chapter3/sort_dataframe.html">4.9. Sort Rows or Columns of a DataFrame</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Chapter3/string.html">4.10. Work with String</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Chapter3/style_dataframe.html">4.11. Style a DataFrame</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Chapter3/testing.html">4.12. Test</a></li>
</ul>
</li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../Chapter4/Chapter4.html">5. NumPy</a><input class="toctree-checkbox" id="toctree-checkbox-5" name="toctree-checkbox-5" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-5"><i class="fa-solid fa-chevron-down"></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../Chapter4/Numpy.html">5.1. NumPy</a></li>
</ul>
</li>
<li class="toctree-l1 current active has-children"><a class="reference internal" href="Chapter5.html">6. Data Science Tools</a><input checked="" class="toctree-checkbox" id="toctree-checkbox-6" name="toctree-checkbox-6" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-6"><i class="fa-solid fa-chevron-down"></i></label><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="feature_extraction.html">6.1. Feature Extraction</a></li>
<li class="toctree-l2"><a class="reference internal" href="feature_engineer.html">6.2. Feature Engineer</a></li>
<li class="toctree-l2"><a class="reference internal" href="get_data.html">6.3. Get Data</a></li>
<li class="toctree-l2"><a class="reference internal" href="manage_data.html">6.4. Manage Data</a></li>
<li class="toctree-l2"><a class="reference internal" href="machine_learning.html">6.5. Machine Learning</a></li>
<li class="toctree-l2"><a class="reference internal" href="natural_language_processing.html">6.6. Natural Language Processing</a></li>
<li class="toctree-l2"><a class="reference internal" href="time_series.html">6.7. Time Series</a></li>
<li class="toctree-l2"><a class="reference internal" href="sharing_downloading.html">6.8. Sharing and Downloading</a></li>
<li class="toctree-l2"><a class="reference internal" href="speed_up_code.html">6.9. Tools to Speed Up Code</a></li>
<li class="toctree-l2"><a class="reference internal" href="visualization.html">6.10. Visualization</a></li>
<li class="toctree-l2"><a class="reference internal" href="best_python_practice_tools.html">6.11. Tools for Best Python Practices</a></li>
<li class="toctree-l2"><a class="reference internal" href="better_pandas.html">6.12. Better Pandas</a></li>
<li class="toctree-l2 current active"><a class="current reference internal" href="#">6.13. Testing</a></li>
<li class="toctree-l2"><a class="reference internal" href="SQL.html">6.14. SQL Libraries</a></li>
<li class="toctree-l2"><a class="reference internal" href="llm.html">6.15. Large Language Model (LLM)</a></li>
</ul>
</li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../Chapter6/Chapter6.html">7. Cool Tools</a><input class="toctree-checkbox" id="toctree-checkbox-7" name="toctree-checkbox-7" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-7"><i class="fa-solid fa-chevron-down"></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../Chapter6/alternative_approach.html">7.1. Alternative Approach</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Chapter6/workflow_automation.html">7.2. Workflow Automation</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Chapter6/code_review.html">7.3. Code Review</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Chapter6/logging_debugging.html">7.4. Logging and Debugging</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Chapter6/better_outputs.html">7.5. Better Outputs</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Chapter6/git_github.html">7.6. Git and GitHub</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Chapter6/env_management.html">7.7. Environment Management</a></li>
</ul>
</li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../Chapter7/Chapter7.html">8. Jupyter Notebook</a><input class="toctree-checkbox" id="toctree-checkbox-8" name="toctree-checkbox-8" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-8"><i class="fa-solid fa-chevron-down"></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../Chapter7/jupyter_notebook.html">8.1. Jupyter Notebook</a></li>
</ul>
</li>
</ul>

    </div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main">
        
        

<div class="sbt-scroll-pixel-helper"></div>

          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item"><label class="sidebar-toggle primary-toggle btn btn-sm" for="__primary" title="Toggle primary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
  <span class="fa-solid fa-bars"></span>
</label></div>
      
    </div>
  
  
    <div class="header-article-items__end">
      
        <div class="header-article-item">

<div class="article-header-buttons">





<div class="dropdown dropdown-launch-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Launch interactive content">
    <i class="fas fa-rocket"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="https://colab.research.google.com/github/khuyentran1401/Efficient_Python_tricks_and_tools_for_data_scientists/blob/master/./Chapter5/testing.ipynb" target="_blank"
   class="btn btn-sm dropdown-item"
   title="Launch onColab"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  
    <img src="../_static/images/logo_colab.png">
  </span>
<span class="btn__text-container">Colab</span>
</a>
</li>
      
  </ul>
</div>






<div class="dropdown dropdown-source-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Source repositories">
    <i class="fab fa-github"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="https://github.com/khuyentran1401/Efficient_Python_tricks_and_tools_for_data_scientists" target="_blank"
   class="btn btn-sm btn-source-repository-button dropdown-item"
   title="Source repository"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fab fa-github"></i>
  </span>
<span class="btn__text-container">Repository</span>
</a>
</li>
      
      
      
      
      <li><a href="https://github.com/khuyentran1401/Efficient_Python_tricks_and_tools_for_data_scientists/issues/new?title=Issue%20on%20page%20%2FChapter5/testing.html&body=Your%20issue%20content%20here." target="_blank"
   class="btn btn-sm btn-source-issues-button dropdown-item"
   title="Open an issue"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-lightbulb"></i>
  </span>
<span class="btn__text-container">Open issue</span>
</a>
</li>
      
  </ul>
</div>






<div class="dropdown dropdown-download-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Download this page">
    <i class="fas fa-download"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="../_sources/Chapter5/testing.ipynb" target="_blank"
   class="btn btn-sm btn-download-source-button dropdown-item"
   title="Download source file"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="btn__text-container">.ipynb</span>
</a>
</li>
      
      
      
      
      <li>
<button onclick="window.print()"
  class="btn btn-sm btn-download-pdf-button dropdown-item"
  title="Print to PDF"
  data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="btn__text-container">.pdf</span>
</button>
</li>
      
  </ul>
</div>




<button onclick="toggleFullScreen()"
  class="btn btn-sm btn-fullscreen-button"
  title="Fullscreen mode"
  data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>


<script>
document.write(`
  <button class="btn btn-sm navbar-btn theme-switch-button" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="theme-switch nav-link" data-mode="light"><i class="fa-solid fa-sun fa-lg"></i></span>
    <span class="theme-switch nav-link" data-mode="dark"><i class="fa-solid fa-moon fa-lg"></i></span>
    <span class="theme-switch nav-link" data-mode="auto"><i class="fa-solid fa-circle-half-stroke fa-lg"></i></span>
  </button>
`);
</script>

<script>
document.write(`
  <button class="btn btn-sm navbar-btn search-button search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass fa-lg"></i>
  </button>
`);
</script>
<label class="sidebar-toggle secondary-toggle btn btn-sm" for="__secondary"title="Toggle secondary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="fa-solid fa-list"></span>
</label>
</div></div>
      
    </div>
  
</div>
</div>
              
              

<div id="jb-print-docs-body" class="onlyprint">
    <h1>Testing</h1>
    <!-- Table of contents -->
    <div id="print-main-content">
        <div id="jb-print-toc">
            
            <div>
                <h2> Contents </h2>
            </div>
            <nav aria-label="Page">
                <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#efficiently-resume-work-after-breaks-with-failing-tests">6.13.1. Efficiently Resume Work After Breaks with Failing Tests</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#choose-a-descriptive-name-over-a-short-one-when-naming-your-function">6.13.2. Choose a Descriptive Name Over a Short One When Naming Your Function</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#pytest-benchmark-a-pytest-fixture-to-benchmark-your-code">6.13.3. pytest benchmark: A Pytest Fixture to Benchmark Your Code</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#pytest-mark-parametrize-test-your-functions-with-multiple-inputs">6.13.4. pytest.mark.parametrize: Test Your Functions with Multiple Inputs</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#pytest-parametrize-twice-test-all-possible-combinations-of-two-sets-of-parameters">6.13.5. pytest parametrize twice: Test All Possible Combinations of Two Sets of Parameters</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#assign-ids-to-test-cases">6.13.6. Assign IDs to Test Cases</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#pytest-fixtures-use-the-same-data-for-different-tests">6.13.7. Pytest Fixtures: Use The Same Data for Different Tests</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#execute-a-fixture-only-once-per-session">6.13.8. Execute a Fixture Only Once per Session</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#pytest-skipif-skip-a-test-when-a-condition-is-not-met">6.13.9. Pytest skipif: Skip a Test When a Condition is Not Met</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#pytest-xfail-mark-a-test-as-expected-to-fail">6.13.10. Pytest xfail: Mark a Test as Expected to Fail</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#test-for-specific-exceptions-in-unit-testing">6.13.11. Test for Specific Exceptions in Unit Testing</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#verify-logging-error-with-pytest">6.13.12. Verify Logging Error with pytest</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#pytest-repeat">6.13.13. Pytest repeat</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#pytest-sugar-show-the-failures-and-errors-instantly-with-a-progress-bar">6.13.14. pytest-sugar: Show the Failures and Errors Instantly With a Progress Bar</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#pytest-steps-share-data-between-tests">6.13.15. pytest-steps: Share Data Between Tests</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#pytest-picked-run-the-tests-related-to-the-unstaged-files-in-git">6.13.16. pytest-picked: Run the Tests Related to the Unstaged Files in Git</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#efficient-testing-of-python-class-with-setup-method">6.13.17. Efficient Testing of Python Class with setUp Method</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#freezegun-freeze-dynamic-time-in-unit-testing">6.13.18. FreezeGun: Freeze Dynamic Time in Unit Testing</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#simulate-external-services-in-testing-with-mock-objects">6.13.19. Simulate External Services in Testing with Mock Objects</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#pyfakefs-create-fake-file-system-in-memory-for-testing">6.13.20. pyfakefs: Create Fake File System in Memory for Testing</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#pandera-a-python-library-to-validate-your-pandas-dataframe">6.13.21. Pandera: a Python Library to Validate Your Pandas DataFrame</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#efficiently-generate-falsified-examples-for-unit-tests-with-pandera-and-hypothesis">6.13.22. Efficiently Generate Falsified Examples for Unit Tests with Pandera and Hypothesis</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#deepdiff-find-deep-differences-of-python-objects">6.13.23. DeepDiff Find Deep Differences of Python Objects</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#dirty-equals-write-declarative-assertions-in-your-unit-tests">6.13.24. dirty-equals: Write Declarative Assertions in Your Unit Tests</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#hypothesis-property-based-testing-in-python">6.13.25. hypothesis: Property-based Testing in Python</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#deepchecks-check-category-mismatch-between-train-and-test-set">6.13.26. Deepchecks: Check Category Mismatch Between Train and Test Set</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#check-conflicting-labels-with-deepchecks">6.13.27. Check Conflicting Labels with Deepchecks</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#evaluate-your-ml-model-performance-with-simple-model-comparison">6.13.28. Evaluate Your ML Model Performance with Simple Model Comparison</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#leab-ab-testing-analysis-in-python">6.13.29. leAB: AB Testing Analysis in Python</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#pytest-postgresql-incorporate-database-testing-into-your-pytest-test-suite">6.13.30. pytest-postgresql: Incorporate Database Testing into Your pytest Test Suite</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#maintain-the-accuracy-of-docstring-examples-with-doctest">6.13.31. Maintain the Accuracy of Docstring Examples with Doctest</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#deepeval-unit-testing-for-your-llm-model">6.13.32. DeepEval: Unit Testing for Your LLM Model</a></li>
</ul>
            </nav>
        </div>
    </div>
</div>

              
                
<div id="searchbox"></div>
                <article class="bd-article" role="main">
                  
  <section id="testing">
<h1><span class="section-number">6.13. </span>Testing<a class="headerlink" href="#testing" title="Permalink to this heading">#</a></h1>
<p><img alt="" src="../_images/test.png" /></p>
<section id="efficiently-resume-work-after-breaks-with-failing-tests">
<h2><span class="section-number">6.13.1. </span>Efficiently Resume Work After Breaks with Failing Tests<a class="headerlink" href="#efficiently-resume-work-after-breaks-with-failing-tests" title="Permalink to this heading">#</a></h2>
<p>Do you forget what feature to implement when taking a break from work?</p>
<p>To keep your train of thought, write a unit test that describes the desired behavior of the feature and makes it fail intentionally.</p>
<p>This will give you a clear idea of what to work on when returning to the project, allowing you to get back on track faster.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">calculate_average</span><span class="p">(</span><span class="n">nums</span><span class="p">:</span> <span class="nb">list</span><span class="p">):</span>
    <span class="k">return</span> <span class="nb">sum</span><span class="p">(</span><span class="n">nums</span><span class="p">)</span><span class="o">/</span><span class="nb">len</span><span class="p">(</span><span class="n">nums</span><span class="p">)</span> 
    <span class="c1"># TODO: code to handle an empty list</span>

<span class="k">def</span> <span class="nf">test_calculate_average_two_nums</span><span class="p">():</span>
    <span class="c1"># Will work</span>
    <span class="n">nums</span> <span class="o">=</span> <span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">]</span>
    <span class="k">assert</span> <span class="n">calculate_average</span><span class="p">(</span><span class="n">nums</span><span class="p">)</span> <span class="o">==</span> <span class="mf">2.5</span>

<span class="k">def</span> <span class="nf">test_calculate_average_empty_list</span><span class="p">():</span>
    <span class="c1"># Will fail intentionally</span>
    <span class="n">nums</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">return</span> <span class="n">calculate_average</span><span class="p">(</span><span class="n">nums</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> 
</pre></div>
</div>
</section>
<section id="choose-a-descriptive-name-over-a-short-one-when-naming-your-function">
<h2><span class="section-number">6.13.2. </span>Choose a Descriptive Name Over a Short One When Naming Your Function<a class="headerlink" href="#choose-a-descriptive-name-over-a-short-one-when-naming-your-function" title="Permalink to this heading">#</a></h2>
<p>Using a short and unclear name for a testing function may lead to confusion and misunderstandings. To make your tests more readable, use a descriptive name instead, even if it results in a longer name.</p>
<p>Instead of this:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">contain_word</span><span class="p">(</span><span class="n">word</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">text</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">word</span> <span class="ow">in</span> <span class="n">text</span>


<span class="k">def</span> <span class="nf">test_contain_word_1</span><span class="p">():</span>
    <span class="k">assert</span> <span class="n">contain_word</span><span class="p">(</span><span class="n">word</span><span class="o">=</span><span class="s2">&quot;duck&quot;</span><span class="p">,</span> <span class="n">text</span><span class="o">=</span><span class="s2">&quot;This is a duck&quot;</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">test_contain_word_2</span><span class="p">():</span>
    <span class="k">assert</span> <span class="n">contain_word</span><span class="p">(</span><span class="n">word</span><span class="o">=</span><span class="s2">&quot;duck&quot;</span><span class="p">,</span> <span class="n">text</span><span class="o">=</span><span class="s2">&quot;This is my coworker, Mr. Duck&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>Write this:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">contain_word</span><span class="p">(</span><span class="n">word</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">text</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">word</span> <span class="ow">in</span> <span class="n">text</span>


<span class="k">def</span> <span class="nf">test_contain_word_exact</span><span class="p">():</span>
    <span class="k">assert</span> <span class="n">contain_word</span><span class="p">(</span><span class="n">word</span><span class="o">=</span><span class="s2">&quot;duck&quot;</span><span class="p">,</span> <span class="n">text</span><span class="o">=</span><span class="s2">&quot;This is a duck&quot;</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">test_contain_word_different_case</span><span class="p">():</span>
    <span class="k">assert</span> <span class="n">contain_word</span><span class="p">(</span><span class="n">word</span><span class="o">=</span><span class="s2">&quot;duck&quot;</span><span class="p">,</span> <span class="n">text</span><span class="o">=</span><span class="s2">&quot;This is my coworker, Mr. Duck&quot;</span><span class="p">)</span>
</pre></div>
</div>
</section>
<section id="pytest-benchmark-a-pytest-fixture-to-benchmark-your-code">
<h2><span class="section-number">6.13.3. </span>pytest benchmark: A Pytest Fixture to Benchmark Your Code<a class="headerlink" href="#pytest-benchmark-a-pytest-fixture-to-benchmark-your-code" title="Permalink to this heading">#</a></h2>
<div class="cell tag_hide-cell docutils container">
<details class="hide above-input">
<summary aria-label="Toggle hidden content">
<span class="collapsed">Show code cell content</span>
<span class="expanded">Hide code cell content</span>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">!</span>pip<span class="w"> </span>install<span class="w"> </span>pytest-benchmark
</pre></div>
</div>
</div>
</details>
</div>
<p>If you want to benchmark your code while testing with pytest, try pytest-benchmark.</p>
<p>To use pytest-benchmark works, add <code class="docutils literal notranslate"><span class="pre">benchmark</span></code> to the test function that you want to benchmark.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%writefile</span> pytest_benchmark_example.py
<span class="k">def</span> <span class="nf">list_comprehension</span><span class="p">(</span><span class="n">len_list</span><span class="o">=</span><span class="mi">5</span><span class="p">):</span>
    <span class="k">return</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">len_list</span><span class="p">)]</span>


<span class="k">def</span> <span class="nf">test_concat</span><span class="p">(</span><span class="n">benchmark</span><span class="p">):</span>
    <span class="n">res</span> <span class="o">=</span> <span class="n">benchmark</span><span class="p">(</span><span class="n">list_comprehension</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">res</span> <span class="o">==</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">]</span>
</pre></div>
</div>
</div>
</div>
<p>On your terminal, type:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$<span class="w"> </span>pytest<span class="w"> </span>pytest_benchmark_example.py
</pre></div>
</div>
<p>Now you should see the statistics of the time it takes to execute the test functions on your terminal:</p>
<div class="cell tag_remove-input docutils container">
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span><span class=" -Color -Color-Bold">============================= test session starts ==============================</span>
platform linux -- Python 3.8.10, pytest-6.2.5, py-1.10.0, pluggy-0.13.1
benchmark: 3.4.1 (defaults: timer=time.perf_counter disable_gc=False min_rounds=5 min_time=0.000005 max_time=1.0 calibration_precision=10 warmup=False warmup_iterations=100000)
rootdir: /home/khuyen/book/book/Chapter4
plugins: hydra-core-1.1.1, Faker-8.12.1, benchmark-3.4.1, repeat-0.9.1, anyio-3.3.0
collected 1 item                                                               

pytest_benchmark_example.py <span class=" -Color -Color-Green">.                                            [100%]</span>


<span class=" -Color -Color-Yellow">----------------------------------------------------- benchmark: 1 tests ----------------------------------------------------</span>
Name (time in ns)          Min         Max      Mean    StdDev    Median     IQR   Outliers  OPS (Mops/s)  Rounds  Iterations
<span class=" -Color -Color-Yellow">-----------------------------------------------------------------------------------------------------------------------------</span>
test_concat         <span class=" -Color -Color-Bold">  286.4501  4,745.5498  309.3872  106.6583  297.5001  5.3500</span>  2686;5843<span class=" -Color -Color-Bold">        3.2322</span>  162101          20
<span class=" -Color -Color-Yellow">-----------------------------------------------------------------------------------------------------------------------------</span>

Legend:
  Outliers: 1 Standard Deviation from Mean; 1.5 IQR (InterQuartile Range) from 1st Quartile and 3rd Quartile.
  OPS: Operations Per Second, computed as 1 / Mean
<span class=" -Color -Color-Green">============================== </span><span class=" -Color -Color-Bold -Color-Bold-Green">1 passed</span><span class=" -Color -Color-Green"> in 2.47s ===============================</span>
</pre></div>
</div>
<script type="application/javascript">
            setTimeout(function() {
                var nbb_cell_id = 42;
                var nbb_unformatted_code = "!pytest pytest_benchmark_example.py ";
                var nbb_formatted_code = "!pytest pytest_benchmark_example.py";
                var nbb_cells = Jupyter.notebook.get_cells();
                for (var i = 0; i < nbb_cells.length; ++i) {
                    if (nbb_cells[i].input_prompt_number == nbb_cell_id) {
                        if (nbb_cells[i].get_text() == nbb_unformatted_code) {
                             nbb_cells[i].set_text(nbb_formatted_code);
                        }
                        break;
                    }
                }
            }, 500);
            </script></div>
</div>
<p><a class="reference external" href="https://github.com/ionelmc/pytest-benchmark">Link to pytest-benchmark</a>.</p>
</section>
<section id="pytest-mark-parametrize-test-your-functions-with-multiple-inputs">
<h2><span class="section-number">6.13.4. </span>pytest.mark.parametrize: Test Your Functions with Multiple Inputs<a class="headerlink" href="#pytest-mark-parametrize-test-your-functions-with-multiple-inputs" title="Permalink to this heading">#</a></h2>
<div class="cell tag_hide-cell docutils container">
<details class="hide above-input">
<summary aria-label="Toggle hidden content">
<span class="collapsed">Show code cell content</span>
<span class="expanded">Hide code cell content</span>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">!</span>pip<span class="w"> </span>install<span class="w"> </span>pytest<span class="w"> </span>
</pre></div>
</div>
</div>
</details>
</div>
<p>If you want to test your function with different examples, use <code class="docutils literal notranslate"><span class="pre">pytest.mark.parametrize</span></code> decorator.</p>
<p>To use <code class="docutils literal notranslate"><span class="pre">pytest.mark.parametrize</span></code>, add <code class="docutils literal notranslate"><span class="pre">&#64;pytest.mark.parametrize</span></code> to the test function that you want to experiment with.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%writefile</span> pytest_parametrize.py
<span class="kn">import</span> <span class="nn">pytest</span>

<span class="k">def</span> <span class="nf">text_contain_word</span><span class="p">(</span><span class="n">word</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">text</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;Find whether the text contains a particular word&#39;&#39;&#39;</span>
    
    <span class="k">return</span> <span class="n">word</span> <span class="ow">in</span> <span class="n">text</span>

<span class="n">test</span> <span class="o">=</span> <span class="p">[</span>
    <span class="p">(</span><span class="s1">&#39;There is a duck in this text&#39;</span><span class="p">,</span><span class="kc">True</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;There is nothing here&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
    <span class="p">]</span>

<span class="nd">@pytest</span><span class="o">.</span><span class="n">mark</span><span class="o">.</span><span class="n">parametrize</span><span class="p">(</span><span class="s1">&#39;sample, expected&#39;</span><span class="p">,</span> <span class="n">test</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">test_text_contain_word</span><span class="p">(</span><span class="n">sample</span><span class="p">,</span> <span class="n">expected</span><span class="p">):</span>

    <span class="n">word</span> <span class="o">=</span> <span class="s1">&#39;duck&#39;</span>

    <span class="k">assert</span> <span class="n">text_contain_word</span><span class="p">(</span><span class="n">word</span><span class="p">,</span> <span class="n">sample</span><span class="p">)</span> <span class="o">==</span> <span class="n">expected</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Writing pytest_parametrize.py
</pre></div>
</div>
</div>
</div>
<p>In the code above, I expect the first sentence to contain the word “duck” and expect the second sentence not to contain that word. Let’s see if my expectations are correct by running:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$<span class="w"> </span>pytest<span class="w"> </span>pytest_parametrize.py
</pre></div>
</div>
<div class="cell tag_remove-input docutils container">
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span><span class=" -Color -Color-Bold">============================= test session starts ==============================</span>
platform darwin -- Python 3.9.6, pytest-7.2.1, pluggy-1.0.0 -- /Users/khuyen/book/venv/bin/python3
cachedir: .pytest_cache
rootdir: /Users/khuyen/book/book/Chapter5
plugins: anyio-3.6.2
collected 2 items                                                              

pytest_parametrize.py::test_text_contain_word[There is a duck in this text-True] <span class=" -Color -Color-Green">PASSED [ 50%]</span>
pytest_parametrize.py::test_text_contain_word[There is nothing here-False] <span class=" -Color -Color-Green">PASSED [100%]</span>

<span class=" -Color -Color-Green">============================== </span><span class=" -Color -Color-Bold -Color-Bold-Green">2 passed</span><span class=" -Color -Color-Green"> in 0.01s ===============================</span>
</pre></div>
</div>
</div>
</div>
<p>Sweet! 2 tests passed when running pytest.</p>
<p><a class="reference external" href="https://towardsdatascience.com/pytest-for-data-scientists-2990319e55e6?sk=2d3a81903b154db0c7ca832b9f29fee8">Link to my article about pytest</a>.</p>
</section>
<section id="pytest-parametrize-twice-test-all-possible-combinations-of-two-sets-of-parameters">
<h2><span class="section-number">6.13.5. </span>pytest parametrize twice: Test All Possible Combinations of Two Sets of Parameters<a class="headerlink" href="#pytest-parametrize-twice-test-all-possible-combinations-of-two-sets-of-parameters" title="Permalink to this heading">#</a></h2>
<div class="cell tag_hide-cell docutils container">
<details class="hide above-input">
<summary aria-label="Toggle hidden content">
<span class="collapsed">Show code cell content</span>
<span class="expanded">Hide code cell content</span>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">!</span>pip<span class="w"> </span>install<span class="w"> </span>pytest<span class="w"> </span>
</pre></div>
</div>
</div>
</details>
</div>
<p>If you want to test the combinations of two sets of parameters, writing all possible combinations can be time-consuming and is difficult to read.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">pytest</span>

<span class="k">def</span> <span class="nf">average</span><span class="p">(</span><span class="n">n1</span><span class="p">,</span> <span class="n">n2</span><span class="p">):</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">n1</span> <span class="o">+</span> <span class="n">n2</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span>

<span class="k">def</span> <span class="nf">perc_difference</span><span class="p">(</span><span class="n">n1</span><span class="p">,</span> <span class="n">n2</span><span class="p">):</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">n2</span> <span class="o">-</span> <span class="n">n1</span><span class="p">)</span><span class="o">/</span><span class="n">n1</span> <span class="o">*</span> <span class="mi">100</span>

<span class="c1"># Test the combinations of operations and inputs</span>
<span class="nd">@pytest</span><span class="o">.</span><span class="n">mark</span><span class="o">.</span><span class="n">parametrize</span><span class="p">(</span><span class="s2">&quot;operation, n1, n2&quot;</span><span class="p">,</span> <span class="p">[(</span><span class="n">average</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="p">(</span><span class="n">average</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span> <span class="p">(</span><span class="n">perc_difference</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="p">(</span><span class="n">perc_difference</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">)])</span>
<span class="k">def</span> <span class="nf">test_is_float</span><span class="p">(</span><span class="n">operation</span><span class="p">,</span> <span class="n">n1</span><span class="p">,</span> <span class="n">n2</span><span class="p">):</span>
    <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">operation</span><span class="p">(</span><span class="n">n1</span><span class="p">,</span> <span class="n">n2</span><span class="p">),</span> <span class="nb">float</span><span class="p">)</span>
</pre></div>
</div>
<p>You can save your time by using <code class="docutils literal notranslate"><span class="pre">pytest.mark.parametrize</span></code> twice instead.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%writefile</span> pytest_combination.py
<span class="kn">import</span> <span class="nn">pytest</span>

<span class="k">def</span> <span class="nf">average</span><span class="p">(</span><span class="n">n1</span><span class="p">,</span> <span class="n">n2</span><span class="p">):</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">n1</span> <span class="o">+</span> <span class="n">n2</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span>

<span class="k">def</span> <span class="nf">perc_difference</span><span class="p">(</span><span class="n">n1</span><span class="p">,</span> <span class="n">n2</span><span class="p">):</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">n2</span> <span class="o">-</span> <span class="n">n1</span><span class="p">)</span><span class="o">/</span><span class="n">n1</span> <span class="o">*</span> <span class="mi">100</span>

<span class="c1"># Test the combinations of operations and inputs</span>
<span class="nd">@pytest</span><span class="o">.</span><span class="n">mark</span><span class="o">.</span><span class="n">parametrize</span><span class="p">(</span><span class="s2">&quot;operation&quot;</span><span class="p">,</span> <span class="p">[</span><span class="n">average</span><span class="p">,</span> <span class="n">perc_difference</span><span class="p">])</span>
<span class="nd">@pytest</span><span class="o">.</span><span class="n">mark</span><span class="o">.</span><span class="n">parametrize</span><span class="p">(</span><span class="s2">&quot;n1, n2&quot;</span><span class="p">,</span> <span class="p">[(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">)])</span>
<span class="k">def</span> <span class="nf">test_is_float</span><span class="p">(</span><span class="n">operation</span><span class="p">,</span> <span class="n">n1</span><span class="p">,</span> <span class="n">n2</span><span class="p">):</span>
    <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">operation</span><span class="p">(</span><span class="n">n1</span><span class="p">,</span> <span class="n">n2</span><span class="p">),</span> <span class="nb">float</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>On your terminal, run:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$<span class="w"> </span>pytest<span class="w"> </span>-v<span class="w"> </span>pytest_combination.py
</pre></div>
</div>
<div class="cell tag_remove-input docutils container">
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span><span class=" -Color -Color-Bold">============================= test session starts ==============================</span>
platform linux -- Python 3.8.10, pytest-6.2.5, py-1.10.0, pluggy-0.13.1 -- /home/khuyen/book/venv/bin/python3
cachedir: .pytest_cache
benchmark: 3.4.1 (defaults: timer=time.perf_counter disable_gc=False min_rounds=5 min_time=0.000005 max_time=1.0 calibration_precision=10 warmup=False warmup_iterations=100000)
hypothesis profile &#39;default&#39; -&gt; database=DirectoryBasedExampleDatabase(&#39;/home/khuyen/book/book/Chapter5/.hypothesis/examples&#39;)
rootdir: /home/khuyen/book/book/Chapter5
plugins: hydra-core-1.1.1, Faker-8.12.1, benchmark-3.4.1, repeat-0.9.1, anyio-3.3.0, hypothesis-6.31.6, typeguard-2.13.3
collected 4 items                                                              

pytest_combination.py::test_is_float[1-2-average] <span class=" -Color -Color-Green">PASSED                 [ 25%]</span>
pytest_combination.py::test_is_float[1-2-perc_difference] <span class=" -Color -Color-Green">PASSED         [ 50%]</span>
pytest_combination.py::test_is_float[2-3-average] <span class=" -Color -Color-Green">PASSED                 [ 75%]</span>
pytest_combination.py::test_is_float[2-3-perc_difference] <span class=" -Color -Color-Green">PASSED         [100%]</span>

<span class=" -Color -Color-Green">============================== </span><span class=" -Color -Color-Bold -Color-Bold-Green">4 passed</span><span class=" -Color -Color-Green"> in 0.27s ===============================</span>
</pre></div>
</div>
</div>
</div>
<p>From the output above, we can see that all possible combinations of the given operations and inputs are tested.</p>
</section>
<section id="assign-ids-to-test-cases">
<h2><span class="section-number">6.13.6. </span>Assign IDs to Test Cases<a class="headerlink" href="#assign-ids-to-test-cases" title="Permalink to this heading">#</a></h2>
<p>When using pytest parametrize, it can be difficult to understand the role of each test case.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%writefile</span> pytest_without_ids.py
<span class="kn">from</span> <span class="nn">pytest</span> <span class="kn">import</span> <span class="n">mark</span>


<span class="k">def</span> <span class="nf">average</span><span class="p">(</span><span class="n">n1</span><span class="p">,</span> <span class="n">n2</span><span class="p">):</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">n1</span> <span class="o">+</span> <span class="n">n2</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span>

<span class="nd">@mark</span><span class="o">.</span><span class="n">parametrize</span><span class="p">(</span>
    <span class="s2">&quot;n1, n2&quot;</span><span class="p">,</span>
    <span class="p">[(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">2</span><span class="p">),</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)],</span>
<span class="p">)</span>
<span class="k">def</span> <span class="nf">test_is_float</span><span class="p">(</span><span class="n">n1</span><span class="p">,</span> <span class="n">n2</span><span class="p">):</span>
    <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">average</span><span class="p">(</span><span class="n">n1</span><span class="p">,</span> <span class="n">n2</span><span class="p">),</span> <span class="nb">float</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$<span class="w"> </span>pytest<span class="w"> </span>-v<span class="w"> </span>pytest_without_ids.py<span class="w"> </span>
</pre></div>
</div>
<div class="cell tag_remove-input docutils container">
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span><span class=" -Color -Color-Bold">============================= test session starts ==============================</span>
platform linux -- Python 3.8.10, pytest-6.2.5, py-1.10.0, pluggy-0.13.1 -- /home/khuyen/book/venv/bin/python3
cachedir: .pytest_cache
benchmark: 3.4.1 (defaults: timer=time.perf_counter disable_gc=False min_rounds=5 min_time=0.000005 max_time=1.0 calibration_precision=10 warmup=False warmup_iterations=100000)
hypothesis profile &#39;default&#39; -&gt; database=DirectoryBasedExampleDatabase(&#39;/home/khuyen/book/book/Chapter5/.hypothesis/examples&#39;)
rootdir: /home/khuyen/book/book/Chapter5
plugins: hydra-core-1.1.1, Faker-8.12.1, benchmark-3.4.1, repeat-0.9.1, anyio-3.3.0, hypothesis-6.31.6, cases-3.6.10, typeguard-2.13.3
collected 3 items                                                              

pytest_without_ids.py::test_is_float[-1--2] <span class=" -Color -Color-Green">PASSED                       [ 33%]</span>
pytest_without_ids.py::test_is_float[2-3] <span class=" -Color -Color-Green">PASSED                         [ 66%]</span>
pytest_without_ids.py::test_is_float[0-0] <span class=" -Color -Color-Green">PASSED                         [100%]</span>

<span class=" -Color -Color-Green">============================== </span><span class=" -Color -Color-Bold -Color-Bold-Green">3 passed</span><span class=" -Color -Color-Green"> in 0.26s ===============================</span>
</pre></div>
</div>
</div>
</div>
<p>You can add <code class="docutils literal notranslate"><span class="pre">ids</span></code> to pytest parametrize to assign a name to each test case.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%writefile</span> pytest_ids.py
<span class="kn">from</span> <span class="nn">pytest</span> <span class="kn">import</span> <span class="n">mark</span>

<span class="k">def</span> <span class="nf">average</span><span class="p">(</span><span class="n">n1</span><span class="p">,</span> <span class="n">n2</span><span class="p">):</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">n1</span> <span class="o">+</span> <span class="n">n2</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span>

<span class="nd">@mark</span><span class="o">.</span><span class="n">parametrize</span><span class="p">(</span>
    <span class="s2">&quot;n1, n2&quot;</span><span class="p">,</span>
    <span class="p">[(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">2</span><span class="p">),</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)],</span>
    <span class="n">ids</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;neg and neg&quot;</span><span class="p">,</span> <span class="s2">&quot;pos and pos&quot;</span><span class="p">,</span> <span class="s2">&quot;zero and zero&quot;</span><span class="p">],</span>
<span class="p">)</span>
<span class="k">def</span> <span class="nf">test_is_float</span><span class="p">(</span><span class="n">n1</span><span class="p">,</span> <span class="n">n2</span><span class="p">):</span>
    <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">average</span><span class="p">(</span><span class="n">n1</span><span class="p">,</span> <span class="n">n2</span><span class="p">),</span> <span class="nb">float</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$<span class="w"> </span>pytest<span class="w"> </span>-v<span class="w"> </span>pytest_ids.py<span class="w"> </span>
</pre></div>
</div>
<div class="cell tag_remove-input docutils container">
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span><span class=" -Color -Color-Bold">============================= test session starts ==============================</span>
platform linux -- Python 3.8.10, pytest-6.2.5, py-1.10.0, pluggy-0.13.1 -- /home/khuyen/book/venv/bin/python3
cachedir: .pytest_cache
benchmark: 3.4.1 (defaults: timer=time.perf_counter disable_gc=False min_rounds=5 min_time=0.000005 max_time=1.0 calibration_precision=10 warmup=False warmup_iterations=100000)
hypothesis profile &#39;default&#39; -&gt; database=DirectoryBasedExampleDatabase(&#39;/home/khuyen/book/book/Chapter5/.hypothesis/examples&#39;)
rootdir: /home/khuyen/book/book/Chapter5
plugins: hydra-core-1.1.1, Faker-8.12.1, benchmark-3.4.1, repeat-0.9.1, anyio-3.3.0, hypothesis-6.31.6, cases-3.6.10, typeguard-2.13.3
collected 3 items                                                              

pytest_ids.py::test_is_float[neg and neg] <span class=" -Color -Color-Green">PASSED                         [ 33%]</span>
pytest_ids.py::test_is_float[pos and pos] <span class=" -Color -Color-Green">PASSED                         [ 66%]</span>
pytest_ids.py::test_is_float[zero and zero] <span class=" -Color -Color-Green">PASSED                       [100%]</span>

<span class=" -Color -Color-Green">============================== </span><span class=" -Color -Color-Bold -Color-Bold-Green">3 passed</span><span class=" -Color -Color-Green"> in 0.27s ===============================</span>
</pre></div>
</div>
</div>
</div>
<p>We can see that instead of <code class="docutils literal notranslate"><span class="pre">[-1--2]</span></code>, the first test case is shown as <code class="docutils literal notranslate"><span class="pre">neg</span> <span class="pre">and</span> <span class="pre">neg</span></code>. This makes it easier for others to understand the roles of your test cases.</p>
<p>If you want to specify the test IDs together with the actual data, instead of listing them separately, use <code class="docutils literal notranslate"><span class="pre">pytest.param</span></code>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%writefile</span> pytest_param.py
<span class="kn">import</span> <span class="nn">pytest</span>


<span class="k">def</span> <span class="nf">average</span><span class="p">(</span><span class="n">n1</span><span class="p">,</span> <span class="n">n2</span><span class="p">):</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">n1</span> <span class="o">+</span> <span class="n">n2</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span>


<span class="n">examples</span> <span class="o">=</span> <span class="p">[</span>
    <span class="n">pytest</span><span class="o">.</span><span class="n">param</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="nb">id</span><span class="o">=</span><span class="s2">&quot;neg-neg&quot;</span><span class="p">),</span>
    <span class="n">pytest</span><span class="o">.</span><span class="n">param</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="nb">id</span><span class="o">=</span><span class="s2">&quot;pos-pos&quot;</span><span class="p">),</span>
    <span class="n">pytest</span><span class="o">.</span><span class="n">param</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">id</span><span class="o">=</span><span class="s2">&quot;0-0&quot;</span><span class="p">),</span>
<span class="p">]</span>


<span class="nd">@pytest</span><span class="o">.</span><span class="n">mark</span><span class="o">.</span><span class="n">parametrize</span><span class="p">(</span><span class="s2">&quot;n1, n2&quot;</span><span class="p">,</span> <span class="n">examples</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">test_is_float</span><span class="p">(</span><span class="n">n1</span><span class="p">,</span> <span class="n">n2</span><span class="p">):</span>
    <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">average</span><span class="p">(</span><span class="n">n1</span><span class="p">,</span> <span class="n">n2</span><span class="p">),</span> <span class="nb">float</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$<span class="w"> </span>pytest<span class="w"> </span>-v<span class="w"> </span>pytest_param.py
</pre></div>
</div>
<div class="cell tag_hide-inpy docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">!</span>pytest<span class="w"> </span>-v<span class="w"> </span>pytest_param.py
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span><span class=" -Color -Color-Bold">============================= test session starts ==============================</span>
platform darwin -- Python 3.8.9, pytest-7.1.2, pluggy-1.0.0 -- /Users/khuyen/book/venv/bin/python3
cachedir: .pytest_cache
rootdir: /Users/khuyen/book/Efficient_Python_tricks_and_tools_for_data_scientists/Chapter5
plugins: anyio-3.6.1, pyfakefs-4.6.3, picked-0.4.6
<span class=" -Color -Color-Bold">collecting ... </span>
<span class=" -Color -Color-Bold">collected 3 items                                                              </span>

pytest_param.py::test_is_float[neg-neg] <span class=" -Color -Color-Green">PASSED                           [ 33%]</span>
pytest_param.py::test_is_float[pos-pos] <span class=" -Color -Color-Green">PASSED                           [ 66%]</span>
pytest_param.py::test_is_float[0-0] <span class=" -Color -Color-Green">PASSED                               [100%]</span>

<span class=" -Color -Color-Green">============================== </span><span class=" -Color -Color-Bold -Color-Bold-Green">3 passed</span><span class=" -Color -Color-Green"> in 0.01s ===============================</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="pytest-fixtures-use-the-same-data-for-different-tests">
<h2><span class="section-number">6.13.7. </span>Pytest Fixtures: Use The Same Data for Different Tests<a class="headerlink" href="#pytest-fixtures-use-the-same-data-for-different-tests" title="Permalink to this heading">#</a></h2>
<div class="cell tag_hide-cell docutils container">
<details class="hide above-input">
<summary aria-label="Toggle hidden content">
<span class="collapsed">Show code cell content</span>
<span class="expanded">Hide code cell content</span>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">!</span>pip<span class="w"> </span>install<span class="w"> </span>pytest<span class="w"> </span>textblob<span class="w"> </span>
</pre></div>
</div>
</div>
</details>
</div>
<p>If you want to use the same data to test different functions, use pytest fixtures.</p>
<p>To use pytest fixtures,  add the decorator <code class="docutils literal notranslate"><span class="pre">&#64;pytest.fixture</span></code> to the function that creates the data you want to reuse.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%writefile</span> pytest_fixture.py
<span class="kn">import</span> <span class="nn">pytest</span> 
<span class="kn">from</span> <span class="nn">textblob</span> <span class="kn">import</span> <span class="n">TextBlob</span>

<span class="k">def</span> <span class="nf">extract_sentiment</span><span class="p">(</span><span class="n">text</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Extract sentimetn using textblob. Polarity is within range [-1, 1]&quot;&quot;&quot;</span>
    
    <span class="n">text</span> <span class="o">=</span> <span class="n">TextBlob</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">text</span><span class="o">.</span><span class="n">sentiment</span><span class="o">.</span><span class="n">polarity</span>

<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span> 
<span class="k">def</span> <span class="nf">example_data</span><span class="p">():</span>
    <span class="k">return</span> <span class="s1">&#39;Today I found a duck and I am happy&#39;</span>

<span class="k">def</span> <span class="nf">test_extract_sentiment</span><span class="p">(</span><span class="n">example_data</span><span class="p">):</span>
    <span class="n">sentiment</span> <span class="o">=</span> <span class="n">extract_sentiment</span><span class="p">(</span><span class="n">example_data</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">sentiment</span> <span class="o">&gt;</span> <span class="mi">0</span>
</pre></div>
</div>
</div>
</div>
<p>On your terminal, type:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$<span class="w"> </span>pytest<span class="w"> </span>pytest_fixture.py
</pre></div>
</div>
<p>Output:</p>
<div class="cell tag_remove-input docutils container">
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span><span class=" -Color -Color-Bold">============================= test session starts ==============================</span>
platform linux -- Python 3.8.10, pytest-6.2.5, py-1.10.0, pluggy-1.0.0
benchmark: 3.4.1 (defaults: timer=time.perf_counter disable_gc=False min_rounds=5 min_time=0.000005 max_time=1.0 calibration_precision=10 warmup=False warmup_iterations=100000)
rootdir: /home/khuyen/book/book/Chapter4
plugins: benchmark-3.4.1, anyio-3.3.0
collected 1 item                                                               

pytest_fixture.py <span class=" -Color -Color-Green">.                                                      [100%]</span>

<span class=" -Color -Color-Green">============================== </span><span class=" -Color -Color-Bold -Color-Bold-Green">1 passed</span><span class=" -Color -Color-Green"> in 0.53s ===============================</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="execute-a-fixture-only-once-per-session">
<h2><span class="section-number">6.13.8. </span>Execute a Fixture Only Once per Session<a class="headerlink" href="#execute-a-fixture-only-once-per-session" title="Permalink to this heading">#</a></h2>
<p>By default, every time you use a pytest fixture in a test, a fixture will be executed.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># example.py</span>
<span class="kn">import</span> <span class="nn">pytest</span> 

<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
<span class="k">def</span> <span class="nf">my_data</span><span class="p">():</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Reading data...&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="mi">1</span>

<span class="k">def</span> <span class="nf">test_division</span><span class="p">(</span><span class="n">my_data</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Test division...&quot;</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">my_data</span> <span class="o">/</span> <span class="mi">2</span> <span class="o">==</span> <span class="mf">0.5</span>

<span class="k">def</span> <span class="nf">test_modulus</span><span class="p">(</span><span class="n">my_data</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Test modulus...&quot;</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">my_data</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">==</span> <span class="mi">1</span>
</pre></div>
</div>
<p>From the output, we can see that the fixture <code class="docutils literal notranslate"><span class="pre">my_data</span></code> is executed twice.</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$<span class="w"> </span>pytest<span class="w"> </span>example.py<span class="w"> </span>-s
Reading<span class="w"> </span>data...
Test<span class="w"> </span>division...
Reading<span class="w"> </span>data...
Test<span class="w"> </span>modulus...
</pre></div>
</div>
<p>If a fixture is expensive to execute, you can make the fixture be executed only once per session using <code class="docutils literal notranslate"><span class="pre">scope=session</span></code>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%writefile</span> pytest_scope.py
<span class="kn">import</span> <span class="nn">pytest</span> 

<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span><span class="p">(</span><span class="n">scope</span><span class="o">=</span><span class="s2">&quot;session&quot;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">my_data</span><span class="p">():</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Reading data...&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="mi">1</span>

<span class="k">def</span> <span class="nf">test_division</span><span class="p">(</span><span class="n">my_data</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Test division...&quot;</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">my_data</span> <span class="o">/</span> <span class="mi">2</span> <span class="o">==</span> <span class="mf">0.5</span>

<span class="k">def</span> <span class="nf">test_modulus</span><span class="p">(</span><span class="n">my_data</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Test modulus...&quot;</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">my_data</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">==</span> <span class="mi">1</span>
</pre></div>
</div>
</div>
</div>
<p>From the output, we can see that the fixture <code class="docutils literal notranslate"><span class="pre">my_data</span></code> is executed only once.</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$<span class="w"> </span>pytest<span class="w"> </span>pytest_scope.py<span class="w"> </span>-s
Reading<span class="w"> </span>data...
Test<span class="w"> </span>division...
Test<span class="w"> </span>modulus...
</pre></div>
</div>
</section>
<section id="pytest-skipif-skip-a-test-when-a-condition-is-not-met">
<h2><span class="section-number">6.13.9. </span>Pytest skipif: Skip a Test When a Condition is Not Met<a class="headerlink" href="#pytest-skipif-skip-a-test-when-a-condition-is-not-met" title="Permalink to this heading">#</a></h2>
<p>If you want to skip a test when a condition is not met, use pytest <code class="docutils literal notranslate"><span class="pre">skipif</span></code>. For example, in the code below, I use <code class="docutils literal notranslate"><span class="pre">skipif</span></code> to skip a test if the python version is less than 3.9.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%writefile</span> pytest_skip.py
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">pytest</span> 

<span class="k">def</span> <span class="nf">add_two</span><span class="p">(</span><span class="n">num</span><span class="p">:</span> <span class="nb">int</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">num</span> <span class="o">+</span> <span class="mi">2</span> 

<span class="nd">@pytest</span><span class="o">.</span><span class="n">mark</span><span class="o">.</span><span class="n">skipif</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">version_info</span> <span class="o">&lt;</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">9</span><span class="p">),</span> <span class="n">reason</span><span class="o">=</span><span class="s2">&quot;Eequires Python 3.9 or higher&quot;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">test_add_two</span><span class="p">():</span> 
    <span class="k">assert</span> <span class="n">add_two</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span> <span class="o">==</span> <span class="mi">5</span>
</pre></div>
</div>
</div>
</div>
<p>On your terminal, type:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$<span class="w"> </span>pytest<span class="w"> </span>pytest_skip.py<span class="w"> </span>-v<span class="w"> </span>
</pre></div>
</div>
<p>Output:</p>
<div class="cell tag_remove-input docutils container">
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span><span class=" -Color -Color-Bold">============================= test session starts ==============================</span>
platform darwin -- Python 3.8.10, pytest-7.1.2, pluggy-1.0.0 -- /Users/khuyen/book/venv/bin/python3
cachedir: .pytest_cache
rootdir: /Users/khuyen/book/Efficient_Python_tricks_and_tools_for_data_scientists/Chapter5
<span class=" -Color -Color-Bold">collecting ... </span>
<span class=" -Color -Color-Bold">collected 1 item                                                               </span>

pytest_skip.py::test_add_two <span class=" -Color -Color-Yellow">SKIPPED</span> (Eequires Python 3.9 or higher)<span class=" -Color -Color-Yellow">     [100%]</span>

<span class=" -Color -Color-Yellow">============================== </span><span class=" -Color -Color-Bold -Color-Bold-Yellow">1 skipped</span><span class=" -Color -Color-Yellow"> in 0.01s ==============================</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="pytest-xfail-mark-a-test-as-expected-to-fail">
<h2><span class="section-number">6.13.10. </span>Pytest xfail: Mark a Test as Expected to Fail<a class="headerlink" href="#pytest-xfail-mark-a-test-as-expected-to-fail" title="Permalink to this heading">#</a></h2>
<p>If you expect a test to fail, use pytest <code class="docutils literal notranslate"><span class="pre">xfail</span></code> marker. This will prevent pytest from marking a test as failed when there is an exception.</p>
<p>To be more specific about what exception you expect to see, use the <code class="docutils literal notranslate"><span class="pre">raises</span></code> argument.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>

<span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span>
    <span class="p">{</span>
        <span class="s2">&quot;col1&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">3</span><span class="p">],</span>
        <span class="s2">&quot;col2&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;a&quot;</span><span class="p">,</span> <span class="s2">&quot;a&quot;</span><span class="p">,</span> <span class="s2">&quot;b&quot;</span><span class="p">,</span> <span class="s2">&quot;b&quot;</span><span class="p">,</span> <span class="s2">&quot;c&quot;</span><span class="p">],</span>
    <span class="p">}</span>
<span class="p">)</span>

<span class="n">df</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s2">&quot;col2&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">agg</span><span class="p">({</span><span class="s2">&quot;col1&quot;</span><span class="p">:</span> <span class="s2">&quot;mean&quot;</span><span class="p">})</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>col1</th>
    </tr>
    <tr>
      <th>col2</th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>a</th>
      <td>1.5</td>
    </tr>
    <tr>
      <th>b</th>
      <td>3.5</td>
    </tr>
    <tr>
      <th>c</th>
      <td>3.0</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%writefile</span> pytest_mark_xfail.py
<span class="kn">import</span> <span class="nn">pytest</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>


<span class="k">def</span> <span class="nf">get_mean</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">group_column</span><span class="p">,</span> <span class="n">value_column</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">df</span><span class="p">[</span><span class="n">group_column</span><span class="p">]</span><span class="o">.</span><span class="n">isna</span><span class="p">()</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Group column contains NaN values&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">df</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">group_column</span><span class="p">)[</span><span class="n">value_column</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>


<span class="nd">@pytest</span><span class="o">.</span><span class="n">mark</span><span class="o">.</span><span class="n">xfail</span><span class="p">(</span><span class="n">raises</span><span class="o">=</span><span class="ne">ValueError</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">test_cget_mean</span><span class="p">():</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="s2">&quot;group&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;a&quot;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> <span class="s2">&quot;b&quot;</span><span class="p">,</span> <span class="s2">&quot;b&quot;</span><span class="p">],</span> <span class="s2">&quot;value&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">0</span><span class="p">]})</span>
    <span class="n">get_mean</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="s2">&quot;group&quot;</span><span class="p">,</span> <span class="s2">&quot;value&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Writing pytest_mark_xfail.py
</pre></div>
</div>
</div>
</div>
<p>On your terminal, type:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$<span class="w"> </span>pytest<span class="w"> </span>pytest_mark_xfail.py
</pre></div>
</div>
<p>We can see that no test failed.</p>
<div class="cell tag_remove-input docutils container">
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span><span class=" -Color -Color-Bold">============================= test session starts ==============================</span>
platform darwin -- Python 3.11.2, pytest-7.4.3, pluggy-1.3.0
rootdir: /Users/khuyentran/book/Efficient_Python_tricks_and_tools_for_data_scientists/Chapter5
plugins: dvc-3.28.0, hydra-core-1.3.2, typeguard-4.1.5, hypothesis-6.88.4
collected 1 item                                                               

pytest_mark_xfail.py <span class=" -Color -Color-Yellow">x                                                   [100%]</span>

<span class=" -Color -Color-Yellow">============================== </span><span class=" -Color -Color-Bold -Color-Bold-Yellow">1 xfailed</span><span class=" -Color -Color-Yellow"> in 0.31s ==============================</span>

</pre></div>
</div>
</div>
</div>
</section>
<section id="test-for-specific-exceptions-in-unit-testing">
<h2><span class="section-number">6.13.11. </span>Test for Specific Exceptions in Unit Testing<a class="headerlink" href="#test-for-specific-exceptions-in-unit-testing" title="Permalink to this heading">#</a></h2>
<p>To test for a specific exception in unit testing, use <code class="docutils literal notranslate"><span class="pre">pytest.raises</span></code>.</p>
<p>For example, you can use it to test if a ValueError is thrown when there are NaN values in the group column.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%writefile</span> pytest_to_fail.py
<span class="kn">import</span> <span class="nn">pytest</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>


<span class="k">def</span> <span class="nf">get_mean</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">group_column</span><span class="p">,</span> <span class="n">value_column</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">df</span><span class="p">[</span><span class="n">group_column</span><span class="p">]</span><span class="o">.</span><span class="n">isna</span><span class="p">()</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Group column contains NaN values&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">df</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">group_column</span><span class="p">)[</span><span class="n">value_column</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>


<span class="k">def</span> <span class="nf">test_get_mean</span><span class="p">():</span>
    <span class="k">with</span> <span class="n">pytest</span><span class="o">.</span><span class="n">raises</span><span class="p">(</span><span class="ne">ValueError</span><span class="p">):</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="s2">&quot;group&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;a&quot;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> <span class="s2">&quot;b&quot;</span><span class="p">,</span> <span class="s2">&quot;b&quot;</span><span class="p">],</span> <span class="s2">&quot;value&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">0</span><span class="p">]})</span>
        <span class="n">get_mean</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="s2">&quot;group&quot;</span><span class="p">,</span> <span class="s2">&quot;value&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Overwriting pytest_to_fail.py
</pre></div>
</div>
</div>
</div>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$<span class="w"> </span>pytest<span class="w"> </span>pytest_to_fail.py
</pre></div>
</div>
<div class="cell tag_remove-input docutils container">
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span><span class=" -Color -Color-Bold">============================= test session starts ==============================</span>
platform darwin -- Python 3.11.2, pytest-7.4.3, pluggy-1.3.0
rootdir: /Users/khuyentran/book/Efficient_Python_tricks_and_tools_for_data_scientists/Chapter5
plugins: dvc-3.28.0, hydra-core-1.3.2, typeguard-4.1.5, hypothesis-6.88.4
collected 1 item                                                               

pytest_to_fail.py <span class=" -Color -Color-Green">.                                                      [100%]</span>

<span class=" -Color -Color-Green">============================== </span><span class=" -Color -Color-Bold -Color-Bold-Green">1 passed</span><span class=" -Color -Color-Green"> in 0.28s ===============================</span>

</pre></div>
</div>
</div>
</div>
</section>
<section id="verify-logging-error-with-pytest">
<h2><span class="section-number">6.13.12. </span>Verify Logging Error with pytest<a class="headerlink" href="#verify-logging-error-with-pytest" title="Permalink to this heading">#</a></h2>
<p>To ensure that your application logs an error under a specific condition, use the built-in fixture called <code class="docutils literal notranslate"><span class="pre">caplog</span></code> in pytest.</p>
<p>This fixture allows you to capture log messages generated during the execution of your test.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%writefile</span> test_logging.py
<span class="kn">from</span> <span class="nn">logging</span> <span class="kn">import</span> <span class="n">getLogger</span>

<span class="n">logger</span> <span class="o">=</span> <span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">divide</span><span class="p">(</span><span class="n">num1</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">num2</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
    <span class="k">if</span> <span class="n">num2</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Can&#39;t divide </span><span class="si">{</span><span class="n">num1</span><span class="si">}</span><span class="s2"> by 0&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Divide </span><span class="si">{</span><span class="n">num1</span><span class="si">}</span><span class="s2"> by </span><span class="si">{</span><span class="n">num2</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">num1</span> <span class="o">/</span> <span class="n">num2</span>

<span class="k">def</span> <span class="nf">test_divide_by_0</span><span class="p">(</span><span class="n">caplog</span><span class="p">):</span>
    <span class="n">divide</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
    <span class="k">assert</span> <span class="s2">&quot;Can&#39;t divide 1 by 0&quot;</span> <span class="ow">in</span> <span class="n">caplog</span><span class="o">.</span><span class="n">text</span>
</pre></div>
</div>
</div>
</div>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$<span class="w"> </span>pytest<span class="w"> </span>test_logging.py
</pre></div>
</div>
<div class="cell tag_remove-input docutils container">
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span><span class=" -Color -Color-Bold">============================= test session starts ==============================</span>
platform darwin -- Python 3.9.6, pytest-7.2.1, pluggy-1.0.0
rootdir: /Users/khuyentran/book/Efficient_Python_tricks_and_tools_for_data_scientists/Chapter5
plugins: anyio-3.6.2
collected 1 item                                                               

<span class=" -Color -Color-Bold">test_logging.py </span><span class=" -Color -Color-Bold -Color-Bold-Green">.</span><span class=" -Color -Color-Green">                                                        [100%]</span>

<span class=" -Color -Color-Green">============================== </span><span class=" -Color -Color-Bold -Color-Bold-Green">1 passed</span><span class=" -Color -Color-Green"> in 0.66s ===============================</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="pytest-repeat">
<h2><span class="section-number">6.13.13. </span>Pytest repeat<a class="headerlink" href="#pytest-repeat" title="Permalink to this heading">#</a></h2>
<div class="cell tag_hide-cell docutils container">
<details class="hide above-input">
<summary aria-label="Toggle hidden content">
<span class="collapsed">Show code cell content</span>
<span class="expanded">Hide code cell content</span>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">!</span>pip<span class="w"> </span>install<span class="w"> </span>pytest-repeat
</pre></div>
</div>
</div>
</details>
</div>
<p>It is a good practice to test your functions to make sure they work as expected, but sometimes you need to test 100 times until you found the rare cases when the test fails. That is when pytest-repeat comes in handy.</p>
<p>To use pytest-repeat, add the decorator <code class="docutils literal notranslate"><span class="pre">&#64;pytest.mark.repeat(N)</span></code> to the test function you want to repeat <code class="docutils literal notranslate"><span class="pre">N</span></code> times</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%</span><span class="k">writfile</span> pytest_repeat_example.py
import pytest 
import random 

def generate_numbers():
    return random.randint(1, 100)

@pytest.mark.repeat(100)
def test_generate_numbers():
    assert generate_numbers() &gt; 1 and generate_numbers() &lt; 100
</pre></div>
</div>
</div>
</div>
<p>On your terminal, type:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$<span class="w"> </span>pytest<span class="w"> </span>pytest_repeat_example.py
</pre></div>
</div>
<p>We can see that 100 experiments are executed and passed:</p>
<div class="cell tag_remove-input docutils container">
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span><span class=" -Color -Color-Bold">============================= test session starts ==============================</span>
platform linux -- Python 3.8.10, pytest-6.2.5, py-1.10.0, pluggy-1.0.0
benchmark: 3.4.1 (defaults: timer=time.perf_counter disable_gc=False min_rounds=5 min_time=0.000005 max_time=1.0 calibration_precision=10 warmup=False warmup_iterations=100000)
rootdir: /home/khuyen/book/book/Chapter4
plugins: benchmark-3.4.1, repeat-0.9.1, anyio-3.3.0
collected 100 items                                                            

pytest_repeat_example.py <span class=" -Color -Color-Green">............................................... [ 47%]</span>
<span class=" -Color -Color-Green">.....................................................                    [100%]</span>

<span class=" -Color -Color-Green">============================= </span><span class=" -Color -Color-Bold -Color-Bold-Green">100 passed</span><span class=" -Color -Color-Green"> in 0.07s ==============================</span>
</pre></div>
</div>
</div>
</div>
<p><a class="reference external" href="https://github.com/pytest-dev/pytest-repeat">Link to pytest-repeat</a></p>
</section>
<section id="pytest-sugar-show-the-failures-and-errors-instantly-with-a-progress-bar">
<h2><span class="section-number">6.13.14. </span>pytest-sugar: Show the Failures and Errors Instantly With a Progress Bar<a class="headerlink" href="#pytest-sugar-show-the-failures-and-errors-instantly-with-a-progress-bar" title="Permalink to this heading">#</a></h2>
<div class="cell tag_hide-cell docutils container">
<details class="hide above-input">
<summary aria-label="Toggle hidden content">
<span class="collapsed">Show code cell content</span>
<span class="expanded">Hide code cell content</span>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">!</span>pip<span class="w"> </span>install<span class="w"> </span>pytest-sugar<span class="w"> </span>
</pre></div>
</div>
</div>
</details>
</div>
<p>It can be frustrating to wait for a lot of tests to run before knowing the status of the tests. If you want to see the failures and errors instantly with a progress bar, use pytest-sugar.</p>
<p>pytest-sugar is a plugin for pytest. To see how pytest-sugar works, assume we have several test files in the <code class="docutils literal notranslate"><span class="pre">pytest_sugar_example</span></code> directory.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%</span><span class="k">ls</span> pytest_sugar_example
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>test_benchmark_example.py  test_parametrize.py
test_fixture.py            test_repeat_example.py
</pre></div>
</div>
</div>
</div>
<p>The code below shows how the outputs will look like when running pytest.</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$<span class="w"> </span>pytest<span class="w"> </span>pytest_sugar_example
</pre></div>
</div>
<div class="cell tag_remove-input docutils container">
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span><span class=" -Color -Color-Bold">Test session starts (platform: linux, Python 3.8.10, pytest 6.2.5, pytest-sugar 0.9.4)</span>
benchmark: 3.4.1 (defaults: timer=time.perf_counter disable_gc=False min_rounds=5 min_time=0.000005 max_time=1.0 calibration_precision=10 warmup=False warmup_iterations=100000)
rootdir: /home/khuyen/book/book/Chapter5
plugins: hydra-core-1.1.1, Faker-8.12.1, benchmark-3.4.1, repeat-0.9.1, anyio-3.3.0, sugar-0.9.4
<span class=" -Color -Color-Bold">collecting ... </span>
 <span class=" -Color -Color-Cyan">pytest_sugar_example/</span>test_benchmark_example.py <span class=" -Color -Color-Green">✓</span>                  <span class=" -Color -Color-Green">1% </span><span class=" -Color -Color-Green -Color-Green-BGBlack">▏         </span>
 <span class=" -Color -Color-Cyan">pytest_sugar_example/</span>test_fixture.py <span class=" -Color -Color-Green">✓</span>                            <span class=" -Color -Color-Green">2% </span><span class=" -Color -Color-Green -Color-Green-BGBlack">▎         </span>
 <span class=" -Color -Color-Cyan">pytest_sugar_example/</span>test_parametrize.py <span class=" -Color -Color-Green">✓✓</span>                       <span class=" -Color -Color-Green">4% </span><span class=" -Color -Color-Green -Color-Green-BGBlack">▍         </span>
 <span class=" -Color -Color-Cyan">pytest_sugar_example/</span>test_repeat_example.py <span class=" -Color -Color-Green">✓✓✓✓✓✓✓✓✓✓✓✓✓✓✓✓✓✓✓✓</span> <span class=" -Color -Color-Green">23% </span><span class=" -Color -Color-Green -Color-Green-BGBlack">██▍       </span>
                                             <span class=" -Color -Color-Green">✓✓✓✓✓✓✓✓✓✓✓✓✓✓✓✓✓✓✓✓</span> <span class=" -Color -Color-Green">42% </span><span class=" -Color -Color-Green -Color-Green-BGBlack">████▎     </span>
                                             <span class=" -Color -Color-Green">✓✓✓✓✓✓✓✓✓✓✓✓✓✓✓✓✓✓✓✓</span> <span class=" -Color -Color-Green">62% </span><span class=" -Color -Color-Green -Color-Green-BGBlack">██████▎   </span>
                                             <span class=" -Color -Color-Green">✓✓✓✓✓✓✓✓✓✓✓✓✓✓✓✓✓✓✓✓</span> <span class=" -Color -Color-Green">81% </span><span class=" -Color -Color-Green -Color-Green-BGBlack">████████▏ </span>
                                             <span class=" -Color -Color-Green">✓✓✓✓✓✓✓✓✓✓✓✓✓✓✓✓✓✓✓✓100% </span><span class=" -Color -Color-Green -Color-Green-BGBlack">██████████</span>

<span class=" -Color -Color-Yellow">---------------------------------------------------- benchmark: 1 tests ---------------------------------------------------</span>
Name (time in ns)          Min         Max      Mean   StdDev    Median     IQR  Outliers  OPS (Mops/s)  Rounds  Iterations
<span class=" -Color -Color-Yellow">---------------------------------------------------------------------------------------------------------------------------</span>
test_concat         <span class=" -Color -Color-Bold">  302.8003  3,012.5000  328.2844  97.9087  321.5999  8.2495</span>  866;2220<span class=" -Color -Color-Bold">        3.0461</span>   90868          20
<span class=" -Color -Color-Yellow">---------------------------------------------------------------------------------------------------------------------------</span>

Legend:
  Outliers: 1 Standard Deviation from Mean; 1.5 IQR (InterQuartile Range) from 1st Quartile and 3rd Quartile.
  OPS: Operations Per Second, computed as 1 / Mean

Results (2.63s):
<span class=" -Color -Color-Green">     104 passed</span>
</pre></div>
</div>
</div>
</div>
<p><a class="reference external" href="https://github.com/Teemu/pytest-sugar">Link to pytest-sugar</a>.</p>
</section>
<section id="pytest-steps-share-data-between-tests">
<h2><span class="section-number">6.13.15. </span>pytest-steps: Share Data Between Tests<a class="headerlink" href="#pytest-steps-share-data-between-tests" title="Permalink to this heading">#</a></h2>
<p>Have you ever wanted to use the result of one test for another test? That is when pytest_steps comes in handy.</p>
<p><img alt="" src="../_images/pytest_steps.png" /></p>
<p>In the code below, I use the result of <code class="docutils literal notranslate"><span class="pre">sum_test</span></code> as the input of <code class="docutils literal notranslate"><span class="pre">average_2_nums</span></code>. The argument <code class="docutils literal notranslate"><span class="pre">steps_data</span></code> allows me to share the data between 2 tests.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%writefile</span> test_steps.py
<span class="kn">from</span> <span class="nn">pytest_steps</span> <span class="kn">import</span> <span class="n">test_steps</span>


<span class="k">def</span> <span class="nf">sum</span><span class="p">(</span><span class="n">n1</span><span class="p">,</span> <span class="n">n2</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">n1</span> <span class="o">+</span> <span class="n">n2</span>


<span class="k">def</span> <span class="nf">average_2_nums</span><span class="p">(</span><span class="nb">sum</span><span class="p">):</span>
    <span class="k">return</span> <span class="nb">sum</span> <span class="o">/</span> <span class="mi">2</span>


<span class="k">def</span> <span class="nf">sum_test</span><span class="p">(</span><span class="n">steps_data</span><span class="p">):</span>
    <span class="n">res</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">res</span> <span class="o">==</span> <span class="mi">4</span>
    <span class="n">steps_data</span><span class="o">.</span><span class="n">res</span> <span class="o">=</span> <span class="n">res</span>


<span class="k">def</span> <span class="nf">perc_difference_test</span><span class="p">(</span><span class="n">steps_data</span><span class="p">):</span>
    <span class="n">avg</span> <span class="o">=</span> <span class="n">average_2_nums</span><span class="p">(</span><span class="n">steps_data</span><span class="o">.</span><span class="n">res</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">avg</span> <span class="o">==</span> <span class="mi">2</span>


<span class="nd">@test_steps</span><span class="p">(</span><span class="n">sum_test</span><span class="p">,</span> <span class="n">perc_difference_test</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">test_calc_suite</span><span class="p">(</span><span class="n">test_step</span><span class="p">,</span> <span class="n">steps_data</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">test_step</span> <span class="o">==</span> <span class="s1">&#39;sum_test&#39;</span><span class="p">:</span>
        <span class="n">sum_test</span><span class="p">(</span><span class="n">steps_data</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">test_step</span> <span class="o">==</span> <span class="s1">&#39;perc_difference_test&#39;</span><span class="p">:</span>
        <span class="n">perc_difference_test</span><span class="p">(</span><span class="n">steps_data</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$<span class="w"> </span>pytest<span class="w"> </span>test_steps.py
</pre></div>
</div>
<div class="cell tag_remove-input docutils container">
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span><span class=" -Color -Color-Bold">============================= test session starts ==============================</span>
platform darwin -- Python 3.8.10, pytest-7.1.2, pluggy-0.13.1
rootdir: /Users/khuyen/book/Efficient_Python_tricks_and_tools_for_data_scientists/Chapter5
plugins: anyio-3.5.0, steps-1.8.0, typeguard-2.12.1
<span class=" -Color -Color-Bold">collecting ... </span>
<span class=" -Color -Color-Bold">collected 2 items                                                              </span>

test_steps.py <span class=" -Color -Color-Green">..                                                         [100%]</span>

<span class=" -Color -Color-Green">============================== </span><span class=" -Color -Color-Bold -Color-Bold-Green">2 passed</span><span class=" -Color -Color-Green"> in 0.02s ===============================</span>
</pre></div>
</div>
</div>
</div>
<p><a class="reference external" href="https://smarie.github.io/python-pytest-steps/">Link to pytest_steps</a>.</p>
</section>
<section id="pytest-picked-run-the-tests-related-to-the-unstaged-files-in-git">
<h2><span class="section-number">6.13.16. </span>pytest-picked: Run the Tests Related to the Unstaged Files in Git<a class="headerlink" href="#pytest-picked-run-the-tests-related-to-the-unstaged-files-in-git" title="Permalink to this heading">#</a></h2>
<p>It can be time-consuming to run all tests in your project. Wouldn’t it be nice if you can run only the tests related to the unstaged files in Git? That is when pytest-picked comes in handy.</p>
<p>In the code below, only tests in the file <code class="docutils literal notranslate"><span class="pre">test_picked.py</span></code> are executed because it is an unstaged file.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%writefile</span> test_picked.py
<span class="k">def</span> <span class="nf">plus_one</span><span class="p">(</span><span class="n">num</span><span class="p">:</span> <span class="nb">int</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">num</span> <span class="o">+</span> <span class="mi">1</span>


<span class="k">def</span> <span class="nf">test_plus_one</span><span class="p">():</span>
    <span class="k">assert</span> <span class="n">plus_one</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">==</span> <span class="mi">3</span>
</pre></div>
</div>
</div>
</div>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$<span class="w"> </span>git<span class="w"> </span>status
</pre></div>
</div>
<div class="cell tag_remove-input docutils container">
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>On branch master
Your branch is up to date with &#39;origin/master&#39;.

Untracked files:
  (use &quot;git add &lt;file&gt;...&quot; to include in what will be committed)
	<span class=" -Color -Color-Red">test_picked.py</span>

nothing added to commit but untracked files present (use &quot;git add&quot; to track)
</pre></div>
</div>
</div>
</div>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$<span class="w"> </span>pytest<span class="w"> </span>--picked
</pre></div>
</div>
<div class="cell tag_remove-input docutils container">
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Changed test files... 1. [&#39;test_picked.py&#39;]
Changed test folders... 0. []
<span class=" -Color -Color-Bold">============================= test session starts ==============================</span>
platform darwin -- Python 3.8.9, pytest-7.1.2, pluggy-1.0.0
rootdir: /Users/khuyen/book/Efficient_Python_tricks_and_tools_for_data_scientists/Chapter5
plugins: anyio-3.6.1, picked-0.4.6
<span class=" -Color -Color-Bold">collecting ... </span>
<span class=" -Color -Color-Bold">collected 1 item                                                               </span>

test_picked.py <span class=" -Color -Color-Green">.                                                         [100%]</span>

<span class=" -Color -Color-Green">============================== </span><span class=" -Color -Color-Bold -Color-Bold-Green">1 passed</span><span class=" -Color -Color-Green"> in 0.01s ===============================</span>
</pre></div>
</div>
</div>
</div>
<p><a class="reference external" href="https://github.com/anapaulagomes/pytest-picked">Link to pytest-picked</a>.</p>
</section>
<section id="efficient-testing-of-python-class-with-setup-method">
<h2><span class="section-number">6.13.17. </span>Efficient Testing of Python Class with setUp Method<a class="headerlink" href="#efficient-testing-of-python-class-with-setup-method" title="Permalink to this heading">#</a></h2>
<p>When testing a Python class, it can be repetitive and time-consuming to create multiple instances to test a large number of instance methods.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%writefile</span> get_dog.py 
<span class="k">class</span> <span class="nc">Dog</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">age</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">age</span> <span class="o">=</span> <span class="n">age</span>

    <span class="k">def</span> <span class="nf">walk</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2"> is walking&quot;</span>

    <span class="k">def</span> <span class="nf">bark</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2"> is barking&quot;</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Writing get_dog.py
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%writefile</span> test_get_dog.py
<span class="kn">import</span> <span class="nn">unittest</span>
<span class="kn">from</span> <span class="nn">get_dog</span> <span class="kn">import</span> <span class="n">Dog</span>

<span class="k">class</span> <span class="nc">TestDog</span><span class="p">(</span><span class="n">unittest</span><span class="o">.</span><span class="n">TestCase</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">test_walk</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">dog</span> <span class="o">=</span> <span class="n">Dog</span><span class="p">(</span><span class="s2">&quot;Max&quot;</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span> 
        <span class="n">dog</span><span class="o">.</span><span class="n">walk</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;Max is walking&quot;</span>

    <span class="k">def</span> <span class="nf">test_bark</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">dog</span> <span class="o">=</span> <span class="n">Dog</span><span class="p">(</span><span class="s2">&quot;Max&quot;</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span> 
        <span class="n">dog</span><span class="o">.</span><span class="n">bark</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;Max is barking&quot;</span>
</pre></div>
</div>
</div>
</div>
<p>A better approach is to use the <code class="docutils literal notranslate"><span class="pre">setUp</span></code> method to instantiate a class object before running each test.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%writefile</span> test_get_dog.py
<span class="kn">import</span> <span class="nn">unittest</span>
<span class="kn">from</span> <span class="nn">get_dog</span> <span class="kn">import</span> <span class="n">Dog</span>

<span class="k">class</span> <span class="nc">TestDog</span><span class="p">(</span><span class="n">unittest</span><span class="o">.</span><span class="n">TestCase</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">setUp</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dog</span> <span class="o">=</span> <span class="n">Dog</span><span class="p">(</span><span class="s2">&quot;Max&quot;</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">test_walk</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dog</span><span class="o">.</span><span class="n">walk</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;Max is walking&quot;</span>

    <span class="k">def</span> <span class="nf">test_bark</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dog</span><span class="o">.</span><span class="n">bark</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;Max is barking&quot;</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Writing test_get_dog.py
</pre></div>
</div>
</div>
</div>
</section>
<section id="freezegun-freeze-dynamic-time-in-unit-testing">
<h2><span class="section-number">6.13.18. </span>FreezeGun: Freeze Dynamic Time in Unit Testing<a class="headerlink" href="#freezegun-freeze-dynamic-time-in-unit-testing" title="Permalink to this heading">#</a></h2>
<div class="cell tag_hide-cell docutils container">
<details class="hide above-input">
<summary aria-label="Toggle hidden content">
<span class="collapsed">Show code cell content</span>
<span class="expanded">Hide code cell content</span>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">!</span>pip<span class="w"> </span>install<span class="w"> </span>freezegun
</pre></div>
</div>
</div>
</details>
</div>
<p>Unit tests require static input, but time is dynamic and constantly changing. With FreezeGun, you can freeze time to a specific point, ensuring accurate verification of the tested features.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%writefile</span> test_freezegun.py
<span class="kn">from</span> <span class="nn">freezegun</span> <span class="kn">import</span> <span class="n">freeze_time</span>
<span class="kn">import</span> <span class="nn">datetime</span> 

<span class="k">def</span> <span class="nf">get_day_of_week</span><span class="p">():</span>
    <span class="k">return</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">weekday</span><span class="p">()</span>

<span class="nd">@freeze_time</span><span class="p">(</span><span class="s2">&quot;2023-06-13&quot;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">test_get_day_of_week</span><span class="p">():</span>
    <span class="k">assert</span> <span class="n">get_day_of_week</span><span class="p">()</span> <span class="o">==</span> <span class="mi">1</span>
</pre></div>
</div>
</div>
</div>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$<span class="w"> </span>pytest<span class="w"> </span>test_freezegun.py
</pre></div>
</div>
<div class="cell tag_remove-input docutils container">
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span><span class=" -Color -Color-Bold">============================= test session starts ==============================</span>
platform darwin -- Python 3.9.6, pytest-7.2.1, pluggy-1.0.0
rootdir: /Users/khuyentran/book/Efficient_Python_tricks_and_tools_for_data_scientists/Chapter5
plugins: anyio-3.6.2
collected 1 item                                                               

test_freezegun.py <span class=" -Color -Color-Green">.                                                      [100%]</span>

<span class=" -Color -Color-Green">============================== </span><span class=" -Color -Color-Bold -Color-Bold-Green">1 passed</span><span class=" -Color -Color-Green"> in 0.03s ===============================</span>
</pre></div>
</div>
</div>
</div>
<p><a class="reference external" href="https://github.com/spulec/freezegun">Link to FreezeGun</a>.</p>
</section>
<section id="simulate-external-services-in-testing-with-mock-objects">
<h2><span class="section-number">6.13.19. </span>Simulate External Services in Testing with Mock Objects<a class="headerlink" href="#simulate-external-services-in-testing-with-mock-objects" title="Permalink to this heading">#</a></h2>
<p>Testing code that relies on external services, like a database, can be difficult since the behaviors of these services can change.</p>
<p>A mock object can control the behavior of a real object in a testing environment by simulating responses from external services.</p>
<p>The following code uses a mock object to test the <code class="docutils literal notranslate"><span class="pre">get_data</span></code> function’s behavior when calling an API that may either succeed or fail.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">unittest.mock</span> <span class="kn">import</span> <span class="n">patch</span>
<span class="kn">import</span> <span class="nn">requests</span>
<span class="kn">from</span> <span class="nn">requests.exceptions</span> <span class="kn">import</span> <span class="ne">ConnectionError</span>


<span class="k">def</span> <span class="nf">get_data</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Make an API call to Postgres&quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;http://localhost:5432&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">response</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>
    <span class="k">except</span> <span class="ne">ConnectionError</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">None</span>


<span class="k">def</span> <span class="nf">test_get_data_fails</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Test the get_data function when the API call fails&quot;&quot;&quot;</span>
    <span class="c1"># Mock the requests.get function</span>
    <span class="k">with</span> <span class="n">patch</span><span class="p">(</span><span class="s2">&quot;requests.get&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">mock_get</span><span class="p">:</span>
        <span class="c1"># Define what happens when the function is called</span>
        <span class="n">mock_get</span><span class="o">.</span><span class="n">side_effect</span> <span class="o">=</span> <span class="ne">ConnectionError</span>
        <span class="k">assert</span> <span class="n">get_data</span><span class="p">()</span> <span class="ow">is</span> <span class="kc">None</span>


<span class="k">def</span> <span class="nf">test_get_data_succeeds</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Test the get_data function when the API call succeeds&quot;&quot;&quot;</span>
    <span class="c1"># Mock the requests.get function</span>
    <span class="k">with</span> <span class="n">patch</span><span class="p">(</span><span class="s2">&quot;requests.get&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">mock_get</span><span class="p">:</span>
        <span class="c1"># Define the return value of the function</span>
        <span class="n">mock_get</span><span class="o">.</span><span class="n">return_value</span><span class="o">.</span><span class="n">json</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;data&quot;</span><span class="p">:</span> <span class="s2">&quot;test&quot;</span><span class="p">}</span>
        <span class="k">assert</span> <span class="n">get_data</span><span class="p">()</span> <span class="o">==</span> <span class="p">{</span><span class="s2">&quot;data&quot;</span><span class="p">:</span> <span class="s2">&quot;test&quot;</span><span class="p">}</span>

</pre></div>
</div>
<p><a class="reference external" href="https://docs.python.org/3/library/unittest.mock.html">Link to mock</a>.</p>
</section>
<section id="pyfakefs-create-fake-file-system-in-memory-for-testing">
<h2><span class="section-number">6.13.20. </span>pyfakefs: Create Fake File System in Memory for Testing<a class="headerlink" href="#pyfakefs-create-fake-file-system-in-memory-for-testing" title="Permalink to this heading">#</a></h2>
<p>Sometimes you might want to test if the function that interacts with files is working properly but don’t want the tests to touch the real disk.</p>
<p>pyfakefs allows your tests to operate on a file system in memory without touching the real disk.</p>
<p>In the code below, I created a fake directory and tested if <code class="docutils literal notranslate"><span class="pre">save_result</span></code> is creating a new file in the fake directory and writing the result to that file.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%writefile</span> test_pyfakefs.py
<span class="kn">from</span> <span class="nn">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>


<span class="k">def</span> <span class="nf">save_result</span><span class="p">(</span><span class="n">folder</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">file_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">result</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
    <span class="c1"># Create new file inside the folder</span>
    <span class="n">file</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">folder</span><span class="p">)</span> <span class="o">/</span> <span class="n">file_name</span>
    <span class="n">file</span><span class="o">.</span><span class="n">touch</span><span class="p">()</span>

    <span class="c1"># Write result to the new file</span>
    <span class="n">file</span><span class="o">.</span><span class="n">write_text</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">test_save_result</span><span class="p">(</span><span class="n">fs</span><span class="p">):</span>
    <span class="n">folder</span> <span class="o">=</span> <span class="s2">&quot;new&quot;</span>
    <span class="n">file_name</span> <span class="o">=</span> <span class="s2">&quot;my_file.txt&quot;</span>
    <span class="n">result</span> <span class="o">=</span> <span class="s2">&quot;The accuracy is 0.9&quot;</span>

    <span class="n">fs</span><span class="o">.</span><span class="n">create_dir</span><span class="p">(</span><span class="n">folder</span><span class="p">)</span>

    <span class="n">save_result</span><span class="p">(</span><span class="n">folder</span><span class="o">=</span><span class="n">folder</span><span class="p">,</span> <span class="n">file_name</span><span class="o">=</span><span class="n">file_name</span><span class="p">,</span> <span class="n">result</span><span class="o">=</span><span class="n">result</span><span class="p">)</span>
    <span class="n">res</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">folder</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">file_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">read_text</span><span class="p">()</span>
    <span class="k">assert</span> <span class="n">res</span> <span class="o">==</span> <span class="n">result</span>
</pre></div>
</div>
</div>
</div>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$<span class="w"> </span>pytest<span class="w"> </span>test_pyfakefs.py
</pre></div>
</div>
<div class="cell tag_remove-input docutils container">
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span><span class=" -Color -Color-Bold">============================= test session starts ==============================</span>
platform darwin -- Python 3.8.9, pytest-7.1.2, pluggy-1.0.0
rootdir: /Users/khuyen/book/book/Chapter5
plugins: anyio-3.6.1, pyfakefs-4.6.3, picked-0.4.6
collected 1 item                                                               

test_pyfakefs.py <span class=" -Color -Color-Green">.                                                       [100%]</span>

<span class=" -Color -Color-Green">============================== </span><span class=" -Color -Color-Bold -Color-Bold-Green">1 passed</span><span class=" -Color -Color-Green"> in 0.76s ===============================</span>
</pre></div>
</div>
</div>
</div>
<p><a class="reference external" href="https://github.com/jmcgeheeiv/pyfakefs/">Link to pyfakefs</a>.</p>
</section>
<section id="pandera-a-python-library-to-validate-your-pandas-dataframe">
<h2><span class="section-number">6.13.21. </span>Pandera: a Python Library to Validate Your Pandas DataFrame<a class="headerlink" href="#pandera-a-python-library-to-validate-your-pandas-dataframe" title="Permalink to this heading">#</a></h2>
<div class="cell tag_hide-cell docutils container">
<details class="hide above-input">
<summary aria-label="Toggle hidden content">
<span class="collapsed">Show code cell content</span>
<span class="expanded">Hide code cell content</span>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">!</span>pip<span class="w"> </span>install<span class="w"> </span>-U<span class="w"> </span>pandera
</pre></div>
</div>
</div>
</details>
</div>
<p>Poor data quality can lead to incorrect conclusions and bad model performance. Thus, it is important to check data for consistency and reliability before using it.</p>
<p>pandera makes it easy to perform data validation on dataframe-like objects. If the dataframe does not pass validation checks, pandera provides useful error messages.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>

<span class="n">fruits</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span>
    <span class="p">{</span>
        <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;apple&quot;</span><span class="p">,</span> <span class="s2">&quot;banana&quot;</span><span class="p">,</span> <span class="s2">&quot;apple&quot;</span><span class="p">],</span>
        <span class="s2">&quot;store&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;Aldi&quot;</span><span class="p">,</span> <span class="s2">&quot;Walmart&quot;</span><span class="p">,</span> <span class="s2">&quot;Walmart&quot;</span><span class="p">],</span>
        <span class="s2">&quot;price&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">4</span><span class="p">],</span>
    <span class="p">}</span>
<span class="p">)</span>

<span class="n">fruits</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>name</th>
      <th>store</th>
      <th>price</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>apple</td>
      <td>Aldi</td>
      <td>2</td>
    </tr>
    <tr>
      <th>1</th>
      <td>banana</td>
      <td>Walmart</td>
      <td>1</td>
    </tr>
    <tr>
      <th>2</th>
      <td>apple</td>
      <td>Walmart</td>
      <td>4</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">available_fruits</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;apple&quot;</span><span class="p">,</span> <span class="s2">&quot;banana&quot;</span><span class="p">,</span> <span class="s2">&quot;orange&quot;</span><span class="p">]</span>
<span class="n">nearby_stores</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;Aldi&quot;</span><span class="p">,</span> <span class="s2">&quot;Walmart&quot;</span><span class="p">]</span>

<span class="kn">import</span> <span class="nn">pandera</span> <span class="k">as</span> <span class="nn">pa</span>
<span class="kn">from</span> <span class="nn">pandera</span> <span class="kn">import</span> <span class="n">Column</span><span class="p">,</span> <span class="n">Check</span>

<span class="n">schema</span> <span class="o">=</span> <span class="n">pa</span><span class="o">.</span><span class="n">DataFrameSchema</span><span class="p">(</span>
    <span class="p">{</span>
        <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="n">Column</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">Check</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">available_fruits</span><span class="p">)),</span>
        <span class="s2">&quot;store&quot;</span><span class="p">:</span> <span class="n">Column</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">Check</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">nearby_stores</span><span class="p">)),</span>
        <span class="s2">&quot;price&quot;</span><span class="p">:</span> <span class="n">Column</span><span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="n">Check</span><span class="o">.</span><span class="n">less_than</span><span class="p">(</span><span class="mi">4</span><span class="p">)),</span>
    <span class="p">}</span>
<span class="p">)</span>
<span class="n">schema</span><span class="o">.</span><span class="n">validate</span><span class="p">(</span><span class="n">fruits</span><span class="p">)</span> <span class="c1"># validation fails</span>
</pre></div>
</div>
</div>
</div>
<p>Output:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>SchemaError:<span class="w">  </span>failed<span class="w"> </span>element-wise<span class="w"> </span>validator<span class="w"> </span><span class="m">0</span>:

failure<span class="w"> </span>cases:
<span class="w">   </span>index<span class="w">  </span>failure_case
<span class="m">0</span><span class="w">      </span><span class="m">2</span><span class="w">             </span><span class="m">4</span>
</pre></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">schema</span> <span class="o">=</span> <span class="n">pa</span><span class="o">.</span><span class="n">DataFrameSchema</span><span class="p">(</span>
    <span class="p">{</span>
        <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="n">Column</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">Check</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">available_fruits</span><span class="p">)),</span>
        <span class="s2">&quot;store&quot;</span><span class="p">:</span> <span class="n">Column</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">Check</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">nearby_stores</span><span class="p">)),</span>
        <span class="s2">&quot;price&quot;</span><span class="p">:</span> <span class="n">Column</span><span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="n">Check</span><span class="o">.</span><span class="n">less_than</span><span class="p">(</span><span class="mi">5</span><span class="p">)),</span>
    <span class="p">}</span>
<span class="p">)</span>
<span class="n">schema</span><span class="o">.</span><span class="n">validate</span><span class="p">(</span><span class="n">fruits</span><span class="p">)</span> <span class="c1"># validation succeeds</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>name</th>
      <th>store</th>
      <th>price</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>apple</td>
      <td>Aldi</td>
      <td>2</td>
    </tr>
    <tr>
      <th>1</th>
      <td>banana</td>
      <td>Walmart</td>
      <td>1</td>
    </tr>
    <tr>
      <th>2</th>
      <td>apple</td>
      <td>Walmart</td>
      <td>3</td>
    </tr>
    <tr>
      <th>3</th>
      <td>orange</td>
      <td>Aldi</td>
      <td>4</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<p>With pandera’s decorator <code class="docutils literal notranslate"><span class="pre">check_input</span></code>, you can validate input data before calling a function.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">pandera</span> <span class="kn">import</span> <span class="n">check_input</span>


<span class="n">fruits</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span>
    <span class="p">{</span>
        <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;apple&quot;</span><span class="p">,</span> <span class="s2">&quot;banana&quot;</span><span class="p">,</span> <span class="s2">&quot;apple&quot;</span><span class="p">],</span>
        <span class="s2">&quot;store&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;Aldi&quot;</span><span class="p">,</span> <span class="s2">&quot;Walmart&quot;</span><span class="p">,</span> <span class="s2">&quot;Walmart&quot;</span><span class="p">],</span>
        <span class="s2">&quot;price&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">5</span><span class="p">],</span>
    <span class="p">}</span>
<span class="p">)</span>

<span class="n">schema</span> <span class="o">=</span> <span class="n">pa</span><span class="o">.</span><span class="n">DataFrameSchema</span><span class="p">(</span>
    <span class="p">{</span>
        <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="n">Column</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">Check</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">available_fruits</span><span class="p">)),</span>
        <span class="s2">&quot;store&quot;</span><span class="p">:</span> <span class="n">Column</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">Check</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">nearby_stores</span><span class="p">)),</span>
        <span class="s2">&quot;price&quot;</span><span class="p">:</span> <span class="n">Column</span><span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="n">Check</span><span class="o">.</span><span class="n">less_than</span><span class="p">(</span><span class="mi">6</span><span class="p">)),</span>
    <span class="p">}</span>
<span class="p">)</span>

<span class="nd">@check_input</span><span class="p">(</span><span class="n">schema</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">get_total_price</span><span class="p">(</span><span class="n">fruits</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">fruits</span><span class="o">.</span><span class="n">price</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>

<span class="n">get_total_price</span><span class="p">(</span><span class="n">fruits</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>8
</pre></div>
</div>
</div>
</div>
<p><a class="reference external" href="https://pandera.readthedocs.io/en/stable/">Link to Pandera</a></p>
</section>
<section id="efficiently-generate-falsified-examples-for-unit-tests-with-pandera-and-hypothesis">
<h2><span class="section-number">6.13.22. </span>Efficiently Generate Falsified Examples for Unit Tests with Pandera and Hypothesis<a class="headerlink" href="#efficiently-generate-falsified-examples-for-unit-tests-with-pandera-and-hypothesis" title="Permalink to this heading">#</a></h2>
<div class="cell tag_hide-cell docutils container">
<details class="hide above-input">
<summary aria-label="Toggle hidden content">
<span class="collapsed">Show code cell content</span>
<span class="expanded">Hide code cell content</span>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">!</span>pip<span class="w"> </span>install<span class="w"> </span>hypothesis<span class="w"> </span>pandera<span class="w"> </span>pytest
</pre></div>
</div>
</div>
</details>
</div>
<p>Generating readable edge cases for unit tests can often be a challenging task. However, with the combined power of Pandera and Hypothesis, you can efficiently detect falsified examples and write cleaner tests.</p>
<p>Pandera allows you to define constraints for inputs and outputs, while Hypothesis automatically identifies edge cases that match the specified schema. Hypothesis further simplifies complex examples until it finds a smaller example that still reproduces the issue.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%writefile</span> test_processing_fn.py
<span class="kn">import</span> <span class="nn">hypothesis</span>
<span class="kn">import</span> <span class="nn">pandera</span> <span class="k">as</span> <span class="nn">pa</span>

<span class="c1"># Specify the schema of the df used for testing</span>
<span class="n">schema</span> <span class="o">=</span> <span class="n">pa</span><span class="o">.</span><span class="n">DataFrameSchema</span><span class="p">(</span>
    <span class="p">{</span>
        <span class="s2">&quot;val1&quot;</span><span class="p">:</span> <span class="n">pa</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="n">pa</span><span class="o">.</span><span class="n">Check</span><span class="o">.</span><span class="n">in_range</span><span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">)),</span>
        <span class="s2">&quot;val2&quot;</span><span class="p">:</span> <span class="n">pa</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="n">pa</span><span class="o">.</span><span class="n">Check</span><span class="o">.</span><span class="n">in_range</span><span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">)),</span>
    <span class="p">}</span>
<span class="p">)</span>

<span class="n">out_schema</span> <span class="o">=</span> <span class="n">schema</span><span class="o">.</span><span class="n">add_columns</span><span class="p">(</span>
    <span class="p">{</span>
        <span class="s2">&quot;val3&quot;</span><span class="p">:</span> <span class="n">pa</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="nb">float</span><span class="p">,</span> <span class="n">pa</span><span class="o">.</span><span class="n">Check</span><span class="o">.</span><span class="n">in_range</span><span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">)),</span>
    <span class="p">},</span>
<span class="p">)</span>


<span class="nd">@pa</span><span class="o">.</span><span class="n">check_output</span><span class="p">(</span><span class="n">out_schema</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">processing_fn</span><span class="p">(</span><span class="n">df</span><span class="p">):</span>
    <span class="n">processed</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">val3</span><span class="o">=</span><span class="n">df</span><span class="o">.</span><span class="n">val1</span><span class="o">/</span><span class="n">df</span><span class="o">.</span><span class="n">val2</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">processed</span>


<span class="nd">@hypothesis</span><span class="o">.</span><span class="n">given</span><span class="p">(</span><span class="n">schema</span><span class="o">.</span><span class="n">strategy</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="mi">5</span><span class="p">))</span> <span class="c1"># Generate 5 examples</span>
<span class="k">def</span> <span class="nf">test_processing_fn</span><span class="p">(</span><span class="n">dataframe</span><span class="p">):</span>
    <span class="n">processing_fn</span><span class="p">(</span><span class="n">dataframe</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Overwriting test_processing_fn.py
</pre></div>
</div>
</div>
</div>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$<span class="w"> </span>pytest<span class="w"> </span>test_processing_fn.py<span class="w"> </span>
</pre></div>
</div>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>test_processing_fn.py<span class="w"> </span>F<span class="w">                                                  </span><span class="o">[</span><span class="m">100</span>%<span class="o">]</span>

<span class="o">===================================</span><span class="w"> </span><span class="nv">FAILURES</span><span class="w"> </span><span class="o">===================================</span>
______________________________<span class="w"> </span>test_processing_fn<span class="w"> </span>______________________________
pandera.errors.SchemaError:<span class="w"> </span>error<span class="w"> </span><span class="k">in</span><span class="w"> </span>check_output<span class="w"> </span>decorator<span class="w"> </span>of<span class="w"> </span><span class="k">function</span><span class="w"> </span><span class="s1">&#39;processing_fn&#39;</span>:<span class="w"> </span>non-nullable<span class="w"> </span>series<span class="w"> </span><span class="s1">&#39;val3&#39;</span><span class="w"> </span>contains<span class="w"> </span>null<span class="w"> </span>values:
<span class="m">0</span><span class="w">   </span>NaN
<span class="m">1</span><span class="w">   </span>NaN
<span class="m">2</span><span class="w">   </span>NaN
<span class="m">3</span><span class="w">   </span>NaN
<span class="m">4</span><span class="w">   </span>NaN
Name:<span class="w"> </span>val3,<span class="w"> </span>dtype:<span class="w"> </span>float64
Falsifying<span class="w"> </span>example:<span class="w"> </span>test_processing_fn<span class="o">(</span>
<span class="w">    </span><span class="nv">dataframe</span><span class="o">=</span>
<span class="w">           </span>val1<span class="w">  </span>val2
<span class="w">        </span><span class="m">0</span><span class="w">     </span><span class="m">0</span><span class="w">     </span><span class="m">0</span>
<span class="w">        </span><span class="m">1</span><span class="w">     </span><span class="m">0</span><span class="w">     </span><span class="m">0</span>
<span class="w">        </span><span class="m">2</span><span class="w">     </span><span class="m">0</span><span class="w">     </span><span class="m">0</span>
<span class="w">        </span><span class="m">3</span><span class="w">     </span><span class="m">0</span><span class="w">     </span><span class="m">0</span>
<span class="w">        </span><span class="m">4</span><span class="w">     </span><span class="m">0</span><span class="w">     </span><span class="m">0</span>
<span class="o">)</span>
</pre></div>
</div>
</section>
<section id="deepdiff-find-deep-differences-of-python-objects">
<h2><span class="section-number">6.13.23. </span>DeepDiff Find Deep Differences of Python Objects<a class="headerlink" href="#deepdiff-find-deep-differences-of-python-objects" title="Permalink to this heading">#</a></h2>
<div class="cell tag_hide-cell docutils container">
<details class="hide above-input">
<summary aria-label="Toggle hidden content">
<span class="collapsed">Show code cell content</span>
<span class="expanded">Hide code cell content</span>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">!</span>pip<span class="w"> </span>install<span class="w"> </span>deepdiff
</pre></div>
</div>
</div>
</details>
</div>
<p>When testing the outputs of your functions, it can be frustrated to see your tests fail because of something you don’t care too much about such as:</p>
<ul class="simple">
<li><p>order of items in a list</p></li>
<li><p>different ways to specify the same thing such as abbreviation</p></li>
<li><p>exact value up to the last decimal point, etc</p></li>
</ul>
<p>Is there a way that you can exclude certain parts of the object from the comparison? That is when DeepDiff comes in handy.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">deepdiff</span> <span class="kn">import</span> <span class="n">DeepDiff</span> 
</pre></div>
</div>
</div>
</div>
<p>DeepDiff can output a meaningful comparison like below:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">price1</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;apple&#39;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span> <span class="s1">&#39;orange&#39;</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span> <span class="s1">&#39;banana&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="mi">2</span><span class="p">]}</span>
<span class="n">price2</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;apple&#39;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span> <span class="s1">&#39;orange&#39;</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span> <span class="s1">&#39;banana&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">]}</span>

<span class="n">DeepDiff</span><span class="p">(</span><span class="n">price1</span><span class="p">,</span> <span class="n">price2</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>{&#39;values_changed&#39;: {&quot;root[&#39;banana&#39;][0]&quot;: {&#39;new_value&#39;: 2, &#39;old_value&#39;: 3},
  &quot;root[&#39;banana&#39;][1]&quot;: {&#39;new_value&#39;: 3, &#39;old_value&#39;: 2}}}
</pre></div>
</div>
</div>
</div>
<p>With DeepDiff, you also have full control of which characteristics of the Python object DeepDiff should ignore. In the example below, since the order is ignored <code class="docutils literal notranslate"><span class="pre">[3,</span> <span class="pre">2]</span></code> is equivalent to <code class="docutils literal notranslate"><span class="pre">[2,</span> <span class="pre">3]</span></code>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Ignore orders </span>

<span class="n">DeepDiff</span><span class="p">(</span><span class="n">price1</span><span class="p">,</span> <span class="n">price2</span><span class="p">,</span> <span class="n">ignore_order</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>{}
</pre></div>
</div>
</div>
</div>
<p>We can also exclude certain part of our object from the comparison. In the code below, we ignore <code class="docutils literal notranslate"><span class="pre">ml</span></code> and <code class="docutils literal notranslate"><span class="pre">machine</span> <span class="pre">learning</span></code> since <code class="docutils literal notranslate"><span class="pre">ml</span></code> is a abbreviation of <code class="docutils literal notranslate"><span class="pre">machine</span> <span class="pre">learning</span></code>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">experience1</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;machine learning&quot;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span> <span class="s2">&quot;python&quot;</span><span class="p">:</span> <span class="mi">3</span><span class="p">}</span>
<span class="n">experience2</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;ml&quot;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span> <span class="s2">&quot;python&quot;</span><span class="p">:</span> <span class="mi">3</span><span class="p">}</span>

<span class="n">DeepDiff</span><span class="p">(</span>
    <span class="n">experience1</span><span class="p">,</span>
    <span class="n">experience2</span><span class="p">,</span>
    <span class="n">exclude_paths</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;root[&#39;ml&#39;]&quot;</span><span class="p">,</span> <span class="s2">&quot;root[&#39;machine learning&#39;]&quot;</span><span class="p">},</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>{}
</pre></div>
</div>
<script type="application/javascript">
            setTimeout(function() {
                var nbb_cell_id = 25;
                var nbb_unformatted_code = "experience1 = {\"machine learning\": 2, \"python\": 3}\nexperience2 = {\"ml\": 2, \"python\": 3}\n\nDeepDiff(\n    experience1,\n    experience2,\n    exclude_paths={\"root['ml']\", \"root['machine learning']\"},\n)";
                var nbb_formatted_code = "experience1 = {\"machine learning\": 2, \"python\": 3}\nexperience2 = {\"ml\": 2, \"python\": 3}\n\nDeepDiff(\n    experience1,\n    experience2,\n    exclude_paths={\"root['ml']\", \"root['machine learning']\"},\n)";
                var nbb_cells = Jupyter.notebook.get_cells();
                for (var i = 0; i < nbb_cells.length; ++i) {
                    if (nbb_cells[i].input_prompt_number == nbb_cell_id) {
                        if (nbb_cells[i].get_text() == nbb_unformatted_code) {
                             nbb_cells[i].set_text(nbb_formatted_code);
                        }
                        break;
                    }
                }
            }, 500);
            </script></div>
</div>
<p>Cmpare 2 numbers up to a specific decimal point:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">num1</span> <span class="o">=</span> <span class="mf">0.258</span>
<span class="n">num2</span> <span class="o">=</span> <span class="mf">0.259</span>

<span class="n">DeepDiff</span><span class="p">(</span><span class="n">num1</span><span class="p">,</span> <span class="n">num2</span><span class="p">,</span> <span class="n">significant_digits</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>{}
</pre></div>
</div>
<script type="application/javascript">
            setTimeout(function() {
                var nbb_cell_id = 34;
                var nbb_unformatted_code = "num1 = 0.258\nnum2 = 0.259\n\nDeepDiff(num1, num2, significant_digits=2)";
                var nbb_formatted_code = "num1 = 0.258\nnum2 = 0.259\n\nDeepDiff(num1, num2, significant_digits=2)";
                var nbb_cells = Jupyter.notebook.get_cells();
                for (var i = 0; i < nbb_cells.length; ++i) {
                    if (nbb_cells[i].input_prompt_number == nbb_cell_id) {
                        if (nbb_cells[i].get_text() == nbb_unformatted_code) {
                             nbb_cells[i].set_text(nbb_formatted_code);
                        }
                        break;
                    }
                }
            }, 500);
            </script></div>
</div>
<p><a class="reference external" href="https://github.com/seperman/deepdiff">Link to DeepDiff</a>.</p>
</section>
<section id="dirty-equals-write-declarative-assertions-in-your-unit-tests">
<h2><span class="section-number">6.13.24. </span>dirty-equals: Write Declarative Assertions in Your Unit Tests<a class="headerlink" href="#dirty-equals-write-declarative-assertions-in-your-unit-tests" title="Permalink to this heading">#</a></h2>
<div class="cell tag_hide-cell docutils container">
<details class="hide above-input">
<summary aria-label="Toggle hidden content">
<span class="collapsed">Show code cell content</span>
<span class="expanded">Hide code cell content</span>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">!</span>pip<span class="w"> </span>install<span class="w"> </span>dirty-equals
</pre></div>
</div>
</div>
</details>
</div>
<p>If you want to write declarative assertions and avoid boilerplate code in your unit tests, try dirty_equals.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">dirty_equals</span> <span class="kn">import</span> <span class="n">IsNow</span><span class="p">,</span> <span class="n">IsPartialDict</span><span class="p">,</span> <span class="n">IsList</span><span class="p">,</span> <span class="n">IsStr</span><span class="p">,</span> <span class="n">IsTrueLike</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span>
<span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">timedelta</span>

<span class="n">shopping</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;time&quot;</span><span class="p">:</span> <span class="n">datetime</span><span class="o">.</span><span class="n">today</span><span class="p">()</span><span class="o">.</span><span class="n">now</span><span class="p">(),</span>
    <span class="s2">&quot;quantity&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;apple&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;banana&quot;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span> <span class="s2">&quot;orange&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">},</span>
    <span class="s2">&quot;locations&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;Walmart&quot;</span><span class="p">,</span> <span class="s2">&quot;Aldi&quot;</span><span class="p">],</span>
    <span class="s2">&quot;is_male&quot;</span><span class="p">:</span> <span class="mi">1</span> 
<span class="p">}</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">assert</span> <span class="n">shopping</span> <span class="o">==</span> <span class="p">{</span>
    <span class="s2">&quot;time&quot;</span><span class="p">:</span> <span class="n">IsNow</span><span class="p">(</span><span class="n">delta</span><span class="o">=</span><span class="n">timedelta</span><span class="p">(</span><span class="n">hours</span><span class="o">=</span><span class="mi">1</span><span class="p">)),</span>
    <span class="s2">&quot;quantity&quot;</span><span class="p">:</span> <span class="n">IsPartialDict</span><span class="p">(</span><span class="n">apple</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">orange</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span>
    <span class="s2">&quot;locations&quot;</span><span class="p">:</span> <span class="n">IsList</span><span class="p">(</span><span class="s2">&quot;Aldi&quot;</span><span class="p">,</span> <span class="s2">&quot;Walmart&quot;</span><span class="p">,</span> <span class="n">check_order</span><span class="o">=</span><span class="kc">False</span><span class="p">),</span>
    <span class="s2">&quot;is_male&quot;</span><span class="p">:</span> <span class="n">IsTrueLike</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
</div>
<p><a class="reference external" href="https://github.com/samuelcolvin/dirty-equals">Link to dirty-equals</a>.</p>
</section>
<section id="hypothesis-property-based-testing-in-python">
<h2><span class="section-number">6.13.25. </span>hypothesis: Property-based Testing in Python<a class="headerlink" href="#hypothesis-property-based-testing-in-python" title="Permalink to this heading">#</a></h2>
<div class="cell tag_hide-code docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">!</span>pip<span class="w"> </span>install<span class="w"> </span>hypothesis
</pre></div>
</div>
</div>
</div>
<p>If you want to test some properties or assumptions, it can be cumbersome to write a wide range of scenarios. To automatically run your tests against a wide range of scenarios and find edge cases in your code that you would otherwise have missed, use hypothesis.</p>
<p>In the code below, I test if the addition of two floats is commutative. The test fails when either <code class="docutils literal notranslate"><span class="pre">x</span></code> or <code class="docutils literal notranslate"><span class="pre">y</span></code> is <code class="docutils literal notranslate"><span class="pre">NaN</span></code>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%writefile</span> test_hypothesis.py 
<span class="kn">from</span> <span class="nn">hypothesis</span> <span class="kn">import</span> <span class="n">given</span>
<span class="kn">from</span> <span class="nn">hypothesis.strategies</span> <span class="kn">import</span> <span class="n">floats</span>



<span class="nd">@given</span><span class="p">(</span><span class="n">floats</span><span class="p">(),</span> <span class="n">floats</span><span class="p">())</span>
<span class="k">def</span> <span class="nf">test_floats_are_commutative</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
    <span class="k">assert</span> <span class="n">x</span> <span class="o">+</span> <span class="n">y</span> <span class="o">==</span> <span class="n">y</span> <span class="o">+</span> <span class="n">x</span>
</pre></div>
</div>
</div>
</div>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$<span class="w"> </span>pytest<span class="w"> </span>test_hypothesis.py
</pre></div>
</div>
<div class="cell tag_remove-input docutils container">
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span><span class=" -Color -Color-Bold">Test session starts (platform: linux, Python 3.8.10, pytest 6.2.5, pytest-sugar 0.9.4)</span>
benchmark: 3.4.1 (defaults: timer=time.perf_counter disable_gc=False min_rounds=5 min_time=0.000005 max_time=1.0 calibration_precision=10 warmup=False warmup_iterations=100000)
rootdir: /home/khuyen/book/book/Chapter5
plugins: hydra-core-1.1.1, Faker-8.12.1, benchmark-3.4.1, repeat-0.9.1, anyio-3.3.0, hypothesis-6.31.6, sugar-0.9.4
<span class=" -Color -Color-Bold">collecting ... </span>

――――――――――――――――――――――――― test_floats_are_commutative ――――――――――――――――――――――――――

    <span class=" -Color -Color-White">@given</span>(floats(), floats())
&gt;   def test_floats_are_commutative(x, y):

<span class=" -Color -Color-Bold -Color-Bold-Red">test_hypothesis.py</span>:7: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

x = 0.0, y = nan

    <span class=" -Color -Color-White">@given</span>(floats(), floats())
    def test_floats_are_commutative(x, y):
&gt;       assert x + y == y + x
<span class=" -Color -Color-Bold -Color-Bold-Red">E       assert (0.0 + nan) == (nan + 0.0)</span>

<span class=" -Color -Color-Bold -Color-Bold-Red">test_hypothesis.py</span>:8: AssertionError
---------------------------------- Hypothesis ----------------------------------
Falsifying example: test_floats_are_commutative(
    x=0.0, y=nan,  # Saw 1 signaling NaN
)

 test_hypothesis.py <span class=" -Color -Color-Red">⨯</span>                                            <span class=" -Color -Color-Red">100% </span><span class=" -Color -Color-Red -Color-Red-BGBlack">██████████</span>
=========================== short test summary info ============================
FAILED test_hypothesis.py::test_floats_are_commutative - assert (0.0 + nan) =...

Results (0.38s):
<span class=" -Color -Color-Red">       1 failed</span>
         - test_hypothesis.py:6 <span class=" -Color -Color-Red">test_floats_are_commutative</span>
</pre></div>
</div>
</div>
</div>
<p>Now I can rewrite my code to make it more robust against these edge cases.</p>
<p><a class="reference external" href="https://hypothesis.readthedocs.io/en/latest/quickstart.html">Link to hypothesis</a>.</p>
</section>
<section id="deepchecks-check-category-mismatch-between-train-and-test-set">
<h2><span class="section-number">6.13.26. </span>Deepchecks: Check Category Mismatch Between Train and Test Set<a class="headerlink" href="#deepchecks-check-category-mismatch-between-train-and-test-set" title="Permalink to this heading">#</a></h2>
<div class="cell tag_hide-cell docutils container">
<details class="hide above-input">
<summary aria-label="Toggle hidden content">
<span class="collapsed">Show code cell content</span>
<span class="expanded">Hide code cell content</span>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">!</span>pip<span class="w"> </span>install<span class="w"> </span>deepchecks<span class="w"> </span>
</pre></div>
</div>
</div>
</details>
</div>
<p>Sometimes, it is important to know if your test set contains the same categories in the train set. If you want to check the category mismatch between the train and test set, use Deepchecks’s <code class="docutils literal notranslate"><span class="pre">CategoryMismatchTrainTest</span></code>.</p>
<p>In the example below, the result shows that there are 2 new categories in the test set. They are ‘d’ and ‘e’.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">deepchecks.checks.integrity.new_category</span> <span class="kn">import</span> <span class="n">CategoryMismatchTrainTest</span>
<span class="kn">from</span> <span class="nn">deepchecks.base</span> <span class="kn">import</span> <span class="n">Dataset</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<script type="application/javascript">
            setTimeout(function() {
                var nbb_cell_id = 18;
                var nbb_unformatted_code = "from deepchecks.checks.integrity.new_category import CategoryMismatchTrainTest\nfrom deepchecks.base import Dataset\nimport pandas as pd";
                var nbb_formatted_code = "from deepchecks.checks.integrity.new_category import CategoryMismatchTrainTest\nfrom deepchecks.base import Dataset\nimport pandas as pd";
                var nbb_cells = Jupyter.notebook.get_cells();
                for (var i = 0; i < nbb_cells.length; ++i) {
                    if (nbb_cells[i].input_prompt_number == nbb_cell_id) {
                        if (nbb_cells[i].get_text() == nbb_unformatted_code) {
                             nbb_cells[i].set_text(nbb_formatted_code);
                        }
                        break;
                    }
                }
            }, 500);
            </script></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">train</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="s2">&quot;col1&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;a&quot;</span><span class="p">,</span> <span class="s2">&quot;b&quot;</span><span class="p">,</span> <span class="s2">&quot;c&quot;</span><span class="p">]})</span>
<span class="n">test</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="s2">&quot;col1&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;c&quot;</span><span class="p">,</span> <span class="s2">&quot;d&quot;</span><span class="p">,</span> <span class="s2">&quot;e&quot;</span><span class="p">]})</span>

<span class="n">train_ds</span> <span class="o">=</span> <span class="n">Dataset</span><span class="p">(</span><span class="n">train</span><span class="p">,</span> <span class="n">cat_features</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;col1&quot;</span><span class="p">])</span>
<span class="n">test_ds</span> <span class="o">=</span> <span class="n">Dataset</span><span class="p">(</span><span class="n">test</span><span class="p">,</span> <span class="n">cat_features</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;col1&quot;</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<script type="application/javascript">
            setTimeout(function() {
                var nbb_cell_id = 19;
                var nbb_unformatted_code = "train = pd.DataFrame({'col1': ['a', 'b', 'c']})\ntest = pd.DataFrame({'col1': ['c', 'd', 'e']})\n\ntrain_ds = Dataset(train, cat_features=['col1'])\ntest_ds = Dataset(test, cat_features=['col1'])";
                var nbb_formatted_code = "train = pd.DataFrame({\"col1\": [\"a\", \"b\", \"c\"]})\ntest = pd.DataFrame({\"col1\": [\"c\", \"d\", \"e\"]})\n\ntrain_ds = Dataset(train, cat_features=[\"col1\"])\ntest_ds = Dataset(test, cat_features=[\"col1\"])";
                var nbb_cells = Jupyter.notebook.get_cells();
                for (var i = 0; i < nbb_cells.length; ++i) {
                    if (nbb_cells[i].input_prompt_number == nbb_cell_id) {
                        if (nbb_cells[i].get_text() == nbb_unformatted_code) {
                             nbb_cells[i].set_text(nbb_formatted_code);
                        }
                        break;
                    }
                }
            }, 500);
            </script></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">CategoryMismatchTrainTest</span><span class="p">()</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">train_ds</span><span class="p">,</span> <span class="n">test_ds</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><h4>Category Mismatch Train Test</h4><p>Find new categories in the test set.</p><h5>Additional Outputs</h5><style type="text/css">
#T_1a4e2_ table {
  text-align: left;
  white-space: pre-wrap;
}
#T_1a4e2_ thead {
  text-align: left;
  white-space: pre-wrap;
}
#T_1a4e2_ tbody {
  text-align: left;
  white-space: pre-wrap;
}
#T_1a4e2_ th {
  text-align: left;
  white-space: pre-wrap;
}
#T_1a4e2_ td {
  text-align: left;
  white-space: pre-wrap;
}
</style>
<table id="T_1a4e2_">
  <thead>
    <tr>
      <th class="blank level0" >&nbsp;</th>
      <th class="col_heading level0 col0" >Number of new categories</th>
      <th class="col_heading level0 col1" >Percent of new categories in sample</th>
      <th class="col_heading level0 col2" >New categories examples</th>
    </tr>
    <tr>
      <th class="index_name level0" >Column</th>
      <th class="blank col0" >&nbsp;</th>
      <th class="blank col1" >&nbsp;</th>
      <th class="blank col2" >&nbsp;</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th id="T_1a4e2_level0_row0" class="row_heading level0 row0" >col1</th>
      <td id="T_1a4e2_row0_col0" class="data row0 col0" >2</td>
      <td id="T_1a4e2_row0_col1" class="data row0 col1" >66.67%</td>
      <td id="T_1a4e2_row0_col2" class="data row0 col2" >['d', 'e']</td>
    </tr>
  </tbody>
</table>
</div><script type="application/javascript">
            setTimeout(function() {
                var nbb_cell_id = 22;
                var nbb_unformatted_code = "CategoryMismatchTrainTest().run(train_ds, test_ds)";
                var nbb_formatted_code = "CategoryMismatchTrainTest().run(train_ds, test_ds)";
                var nbb_cells = Jupyter.notebook.get_cells();
                for (var i = 0; i < nbb_cells.length; ++i) {
                    if (nbb_cells[i].input_prompt_number == nbb_cell_id) {
                        if (nbb_cells[i].get_text() == nbb_unformatted_code) {
                             nbb_cells[i].set_text(nbb_formatted_code);
                        }
                        break;
                    }
                }
            }, 500);
            </script></div>
</div>
<p><a class="reference external" href="https://docs.deepchecks.com/en/stable/">Link to Deepchecks</a></p>
</section>
<section id="check-conflicting-labels-with-deepchecks">
<h2><span class="section-number">6.13.27. </span>Check Conflicting Labels with Deepchecks<a class="headerlink" href="#check-conflicting-labels-with-deepchecks" title="Permalink to this heading">#</a></h2>
<p>Sometimes, your data might have identical samples with different labels. This might be because the data was mislabeled.</p>
<p>It is good to identify these conflicting labels in your data before using the data to train your ML model. To check conflicting labels in your data, use deepchecks.</p>
<p>In the example below, deepchecks identified that samples 0 and 1 have the same features but different labels.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>  
<span class="kn">from</span> <span class="nn">deepchecks.tabular</span> <span class="kn">import</span> <span class="n">Dataset</span> 
<span class="kn">from</span> <span class="nn">deepchecks.tabular.checks</span> <span class="kn">import</span> <span class="n">ConflictingLabels</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span>
    <span class="s2">&quot;value1&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">],</span> 
    <span class="s2">&quot;value2&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">4</span><span class="p">],</span> 
    <span class="s2">&quot;label&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;a&quot;</span><span class="p">,</span> <span class="s2">&quot;b&quot;</span><span class="p">,</span> <span class="s2">&quot;c&quot;</span><span class="p">]</span>
<span class="p">})</span>
<span class="n">df</span> 
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>value1</th>
      <th>value2</th>
      <th>label</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>1</td>
      <td>2</td>
      <td>a</td>
    </tr>
    <tr>
      <th>1</th>
      <td>1</td>
      <td>2</td>
      <td>b</td>
    </tr>
    <tr>
      <th>2</th>
      <td>3</td>
      <td>4</td>
      <td>c</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">dataset</span> <span class="o">=</span> <span class="n">Dataset</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;label&#39;</span><span class="p">)</span>
<span class="n">ConflictingLabels</span><span class="p">()</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">dataset</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>deepchecks - WARNING - It is recommended to initialize Dataset with categorical features by doing &quot;Dataset(df, cat_features=categorical_list)&quot;. No categorical features were passed, therefore heuristically inferring categorical features in the data. 2 categorical features were inferred.: value1, value2
</pre></div>
</div>
<script type="application/vnd.jupyter.widget-view+json">{"model_id": "00283018bced42abab72ff96033fcac1", "version_major": 2, "version_minor": 0}</script></div>
</div>
</section>
<section id="evaluate-your-ml-model-performance-with-simple-model-comparison">
<h2><span class="section-number">6.13.28. </span>Evaluate Your ML Model Performance with Simple Model Comparison<a class="headerlink" href="#evaluate-your-ml-model-performance-with-simple-model-comparison" title="Permalink to this heading">#</a></h2>
<div class="cell tag_hide-cell docutils container">
<details class="hide above-input">
<summary aria-label="Toggle hidden content">
<span class="collapsed">Show code cell content</span>
<span class="expanded">Hide code cell content</span>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">!</span>pip<span class="w"> </span>install<span class="w"> </span>deepchecks
</pre></div>
</div>
</div>
</details>
</div>
<p>How do you check if your ML model is trained properly? One approach is to use a simple model for comparison.</p>
<p>A simple model establishes a minimum performance benchmark for the given task. A model achieving less or a similar score to the simple model indicates a possible problem with the model.</p>
<p>The following code shows how to evaluate a model’s performance using Deepchecks’ simple model comparison.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">deepchecks.tabular.datasets.classification.phishing</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">load_data</span><span class="p">,</span> <span class="n">load_fitted_model</span><span class="p">)</span>

<span class="n">train_dataset</span><span class="p">,</span> <span class="n">test_dataset</span> <span class="o">=</span> <span class="n">load_data</span><span class="p">()</span>
<span class="n">model</span> <span class="o">=</span> <span class="n">load_fitted_model</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">model</span><span class="o">.</span><span class="n">steps</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[(&#39;preprocessing&#39;,
  ColumnTransformer(transformers=[(&#39;num&#39;, SimpleImputer(),
                                   [&#39;urlLength&#39;, &#39;numDigits&#39;, &#39;numParams&#39;,
                                    &#39;num_%20&#39;, &#39;num_@&#39;, &#39;entropy&#39;, &#39;hasHttp&#39;,
                                    &#39;hasHttps&#39;, &#39;dsr&#39;, &#39;dse&#39;, &#39;bodyLength&#39;,
                                    &#39;numTitles&#39;, &#39;numImages&#39;, &#39;numLinks&#39;,
                                    &#39;specialChars&#39;, &#39;scriptLength&#39;, &#39;sbr&#39;, &#39;bscr&#39;,
                                    &#39;sscr&#39;]),
                                  (&#39;cat&#39;,
                                   Pipeline(steps=[(&#39;imputer&#39;,
                                                    SimpleImputer(strategy=&#39;most_frequent&#39;)),
                                                   (&#39;encoder&#39;, OneHotEncoder())]),
                                   [&#39;ext&#39;])])),
 (&#39;model&#39;,
  RandomForestClassifier(criterion=&#39;entropy&#39;, n_estimators=40, random_state=0))]
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">deepchecks.tabular.checks</span> <span class="kn">import</span> <span class="n">SimpleModelComparison</span>

<span class="c1"># Using tree model as a simple model</span>
<span class="n">check</span> <span class="o">=</span> <span class="n">SimpleModelComparison</span><span class="p">(</span><span class="n">strategy</span><span class="o">=</span><span class="s1">&#39;tree&#39;</span><span class="p">)</span>
<span class="n">check</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">train_dataset</span><span class="p">,</span> <span class="n">test_dataset</span><span class="p">,</span> <span class="n">model</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<script type="application/vnd.jupyter.widget-view+json">{"model_id": "18c5dbd0a25d4e25a03f577c98ee641a", "version_major": 2, "version_minor": 0}</script></div>
</div>
<p><a class="reference external" href="https://docs.deepchecks.com/en/stable/">Link to Deepchecks</a></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">sklearn.preprocessing</span> <span class="kn">import</span> <span class="n">MinMaxScaler</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span> 
<span class="c1"># Original data</span>
<span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">9</span><span class="p">]])</span>

<span class="c1"># Scaling transformation</span>
<span class="n">scaler</span> <span class="o">=</span> <span class="n">MinMaxScaler</span><span class="p">(</span><span class="n">feature_range</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
<span class="n">scaled_data</span> <span class="o">=</span> <span class="n">scaler</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

<span class="c1"># Inverse transformation</span>
<span class="n">original_data</span> <span class="o">=</span> <span class="n">scaler</span><span class="o">.</span><span class="n">inverse_transform</span><span class="p">(</span><span class="n">scaled_data</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Original data:&quot;</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Scaled data:&quot;</span><span class="p">,</span> <span class="n">scaled_data</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Restored data:&quot;</span><span class="p">,</span> <span class="n">original_data</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Original data: [[1 3 5 7 9]]
Scaled data: [[0. 0. 0. 0. 0.]]
Restored data: [[1. 3. 5. 7. 9.]]
</pre></div>
</div>
</div>
</div>
</section>
<section id="leab-ab-testing-analysis-in-python">
<h2><span class="section-number">6.13.29. </span>leAB: AB Testing Analysis in Python<a class="headerlink" href="#leab-ab-testing-analysis-in-python" title="Permalink to this heading">#</a></h2>
<div class="cell tag_hide-cell docutils container">
<details class="hide above-input">
<summary aria-label="Toggle hidden content">
<span class="collapsed">Show code cell content</span>
<span class="expanded">Hide code cell content</span>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">!</span>pip<span class="w"> </span>install<span class="w"> </span>leab
</pre></div>
</div>
</div>
</details>
</div>
<p>AB testing is crucial for assessing the effectiveness of changes in a controlled environment. With the leAB library, you can compute the appropriate sample size before launching the test.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">leab</span> <span class="kn">import</span> <span class="n">before</span>

<span class="c1"># What is the number of sample needed per variation to detect a 1% result </span>
<span class="c1"># difference in a population with a 15% conversion rate?</span>
<span class="n">ab_test</span> <span class="o">=</span> <span class="n">before</span><span class="o">.</span><span class="n">leSample</span><span class="p">(</span><span class="n">conversion_rate</span><span class="o">=</span><span class="mi">15</span><span class="p">,</span> <span class="n">min_detectable_effect</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">ab_test</span><span class="o">.</span><span class="n">get_size_per_variation</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>20177
</pre></div>
</div>
</div>
</div>
<p>After reaching the sample size, you can compare the successes between group A and group B.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">leab</span> <span class="kn">import</span> <span class="n">after</span><span class="p">,</span> <span class="n">leDataset</span>

<span class="c1"># Import sample data for A and B</span>
<span class="n">data</span> <span class="o">=</span> <span class="n">leDataset</span><span class="o">.</span><span class="n">SampleLeSuccess</span><span class="p">()</span>
<span class="n">data</span><span class="o">.</span><span class="n">A</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>success</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>1</td>
    </tr>
    <tr>
      <th>1</th>
      <td>0</td>
    </tr>
    <tr>
      <th>2</th>
      <td>1</td>
    </tr>
    <tr>
      <th>3</th>
      <td>1</td>
    </tr>
    <tr>
      <th>4</th>
      <td>0</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">ab_test</span> <span class="o">=</span> <span class="n">after</span><span class="o">.</span><span class="n">leSuccess</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">A</span><span class="p">,</span> <span class="n">data</span><span class="o">.</span><span class="n">B</span><span class="p">,</span> <span class="n">confidence_level</span><span class="o">=</span><span class="mf">0.95</span><span class="p">)</span>

<span class="c1"># Get the conclusion on the test </span>
<span class="n">ab_test</span><span class="o">.</span><span class="n">get_verdict</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&#39;No significant difference&#39;
</pre></div>
</div>
</div>
</div>
<p><a class="reference external" href="https://github.com/tlentali/leab">Link to leAB</a>.</p>
</section>
<section id="pytest-postgresql-incorporate-database-testing-into-your-pytest-test-suite">
<h2><span class="section-number">6.13.30. </span>pytest-postgresql: Incorporate Database Testing into Your pytest Test Suite<a class="headerlink" href="#pytest-postgresql-incorporate-database-testing-into-your-pytest-test-suite" title="Permalink to this heading">#</a></h2>
<div class="cell tag_hide-cell docutils container">
<details class="hide above-input">
<summary aria-label="Toggle hidden content">
<span class="collapsed">Show code cell content</span>
<span class="expanded">Hide code cell content</span>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">!</span>pip<span class="w"> </span>install<span class="w"> </span>pytest-postgresql
</pre></div>
</div>
</div>
</details>
</div>
<p>If you want to incorporate database testing seamlessly within your pytest test suite, use pytest-postgresql.</p>
<p>pytest-postgres provides fixtures that manage the setup and cleanup of test databases, ensuring repeatable tests. Additionally, each test runs in isolation, preventing any impact on the production database from testing changes.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%writefile</span> test_postgres.py 
<span class="k">def</span> <span class="nf">test_query_results</span><span class="p">(</span><span class="n">postgresql</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Check that the query results are as expected.&quot;&quot;&quot;</span>
    <span class="k">with</span> <span class="n">postgresql</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span> <span class="k">as</span> <span class="n">cur</span><span class="p">:</span>
        <span class="n">cur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;CREATE TABLE test_table (id SERIAL PRIMARY KEY, name VARCHAR);&quot;</span><span class="p">)</span>
        <span class="n">cur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;INSERT INTO test_table (name) VALUES (&#39;John&#39;), (&#39;Jane&#39;), (&#39;Alice&#39;);&quot;</span><span class="p">)</span>

        <span class="c1"># Assert the results</span>
        <span class="n">cur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;SELECT * FROM test_table;&quot;</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">cur</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span> <span class="o">==</span> <span class="p">[(</span><span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;John&#39;</span><span class="p">),</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s1">&#39;Jane&#39;</span><span class="p">),</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="s1">&#39;Alice&#39;</span><span class="p">)]</span>
</pre></div>
</div>
</div>
</div>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$<span class="w"> </span>pytest<span class="w"> </span>test_postgres.py<span class="w"> </span>
</pre></div>
</div>
<div class="cell tag_remove-input docutils container">
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span><span class=" -Color -Color-Bold">============================= test session starts ==============================</span>
platform darwin -- Python 3.9.6, pytest-7.2.1, pluggy-1.0.0
rootdir: /Users/khuyentran/book/Efficient_Python_tricks_and_tools_for_data_scientists/Chapter5
plugins: dash-2.10.2, postgresql-5.0.0, anyio-3.6.2
collected 1 item                                                               

test_postgres.py <span class=" -Color -Color-Green">.                                                       [100%]</span>

<span class=" -Color -Color-Green">============================== </span><span class=" -Color -Color-Bold -Color-Bold-Green">1 passed</span><span class=" -Color -Color-Green"> in 1.20s ===============================</span>
</pre></div>
</div>
</div>
</div>
<p><a class="reference external" href="https://github.com/ClearcodeHQ/pytest-postgresql">Link to pytest-postgresql</a>.</p>
</section>
<section id="maintain-the-accuracy-of-docstring-examples-with-doctest">
<h2><span class="section-number">6.13.31. </span>Maintain the Accuracy of Docstring Examples with Doctest<a class="headerlink" href="#maintain-the-accuracy-of-docstring-examples-with-doctest" title="Permalink to this heading">#</a></h2>
<p>Including examples in a docstring is helpful. However, examples can become obsolete as the function evolves.</p>
<p>To ensure that the examples remain accurate, use doctest.</p>
<div class="cell tag_remove-output docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%writefile</span> example.py 
<span class="k">def</span> <span class="nf">perc_difference</span><span class="p">(</span><span class="n">n1</span><span class="p">,</span> <span class="n">n2</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Return the percentage difference between two numbers, n1 and n2.</span>

<span class="sd">    Formula: ((n2 - n1) / n1) * 100</span>

<span class="sd">    Examples:</span>
<span class="sd">    &gt;&gt;&gt; perc_difference(50, 60)</span>
<span class="sd">    20.0</span>
<span class="sd">    &gt;&gt;&gt; perc_difference(100, 100)</span>
<span class="sd">    0.0</span>

<span class="sd">    :param n1: The first number (the original value).</span>
<span class="sd">    :param n2: The second number (the new value).</span>
<span class="sd">    :return: The percentage difference between n1 and n2 as a float.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="p">((</span><span class="n">n2</span> <span class="o">-</span> <span class="n">n1</span><span class="p">)</span> <span class="o">/</span> <span class="n">n1</span><span class="p">)</span> <span class="o">*</span> <span class="mi">100</span>


<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="kn">import</span> <span class="nn">doctest</span>
    <span class="n">doctest</span><span class="o">.</span><span class="n">testmod</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$<span class="w"> </span>python<span class="w"> </span>example.py<span class="w"> </span>-v
</pre></div>
</div>
<div class="cell tag_remove-input docutils container">
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Trying:
    perc_difference(50, 60)
Expecting:
    20.0
ok
Trying:
    perc_difference(100, 100)
Expecting:
    0.0
ok
1 items had no tests:
    __main__
1 items passed all tests:
   2 tests in __main__.perc_difference
2 tests in 2 items.
2 passed and 0 failed.
Test passed.
</pre></div>
</div>
</div>
</div>
</section>
<section id="deepeval-unit-testing-for-your-llm-model">
<h2><span class="section-number">6.13.32. </span>DeepEval: Unit Testing for Your LLM Model<a class="headerlink" href="#deepeval-unit-testing-for-your-llm-model" title="Permalink to this heading">#</a></h2>
<div class="cell tag_hide-cell docutils container">
<details class="hide above-input">
<summary aria-label="Toggle hidden content">
<span class="collapsed">Show code cell content</span>
<span class="expanded">Hide code cell content</span>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">!</span>pip<span class="w"> </span>install<span class="w"> </span>-U<span class="w"> </span>deepeval
</pre></div>
</div>
</div>
</details>
</div>
<p>When deploying an LLM model to production, it’s crucial that the model is accurate, relevant to the specific question, and free from biases.</p>
<p>DeepEval simplifies unit testing of LLM outputs in Python using these criteria.</p>
<p>In the following code, we use DeepEval to check if the LLM output is accurate and aligns with established facts.</p>
<div class="cell tag_remove-output docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%writefile</span> test_chatbot.py
<span class="kn">import</span> <span class="nn">pytest</span>
<span class="kn">from</span> <span class="nn">deepeval.metrics.factual_consistency</span> <span class="kn">import</span> <span class="n">FactualConsistencyMetric</span>
<span class="kn">from</span> <span class="nn">deepeval.test_case</span> <span class="kn">import</span> <span class="n">LLMTestCase</span>
<span class="kn">from</span> <span class="nn">deepeval.run_test</span> <span class="kn">import</span> <span class="n">assert_test</span>

<span class="k">def</span> <span class="nf">test_case</span><span class="p">():</span>
    <span class="n">query</span> <span class="o">=</span> <span class="s2">&quot;What if these shoes don&#39;t fit?&quot;</span>
    <span class="n">context</span> <span class="o">=</span> <span class="s2">&quot;All customers are eligible for a 30 day full refund.&quot;</span>

    <span class="c1"># Replace this with the actual output from your LLM application</span>
    <span class="n">actual_output</span> <span class="o">=</span> <span class="s2">&quot;We offer a 30-day full refund.&quot;</span>
    <span class="n">factual_consistency_metric</span> <span class="o">=</span> <span class="n">FactualConsistencyMetric</span><span class="p">(</span><span class="n">minimum_score</span><span class="o">=</span><span class="mf">0.7</span><span class="p">)</span>
    <span class="n">test_case</span> <span class="o">=</span> <span class="n">LLMTestCase</span><span class="p">(</span><span class="n">query</span><span class="o">=</span><span class="n">query</span><span class="p">,</span> <span class="n">output</span><span class="o">=</span><span class="n">actual_output</span><span class="p">,</span> <span class="n">context</span><span class="o">=</span><span class="n">context</span><span class="p">)</span>
    <span class="n">assert_test</span><span class="p">(</span><span class="n">test_case</span><span class="p">,</span> <span class="p">[</span><span class="n">factual_consistency_metric</span><span class="p">])</span>
</pre></div>
</div>
</div>
</div>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$<span class="w"> </span>deepeval<span class="w"> </span><span class="nb">test</span><span class="w"> </span>run<span class="w"> </span>test_chatbot.py
</pre></div>
</div>
<div class="cell tag_remove-input docutils container">
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span><span class=" -Color -Color-Bold">============================= test session starts ==============================</span>
platform darwin -- Python 3.9.6, pytest-7.2.1, pluggy-1.0.0 -- /Users/khuyentran/book/venv/bin/python3
cachedir: .pytest_cache
rootdir: /Users/khuyentran/book/Efficient_Python_tricks_and_tools_for_data_scientists/Chapter5
plugins: deepeval-0.20.0, postgresql-5.0.0, dash-2.13.0, typeguard-4.1.2, anyio-3.6.2
collected 1 item                                                               

Downloading FactualConsistencyModel (may take up to 2 minutes if running for th…
<span class=" -Color -Color-Green">PASSED</span>Running teardown with pytest sessionfinish<span class=" -Color -Color-Yellow">...</span>


============================= slowest 10 durations =============================
7.00s call     test_chatbot.py::test_case

(2 durations &lt; 0.005s hidden.  Use -vv to show these durations.)
<span class=" -Color -Color-Yellow">======================== </span><span class=" -Color -Color-Green">1 passed</span>, <span class=" -Color -Color-Bold -Color-Bold-Yellow">2 warnings</span><span class=" -Color -Color-Yellow"> in 7.02s =========================</span>
                                 Test Results                                  
┏━━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━┳━━━━━━━━━━┳━━━━━━━━━━━━━━┓
┃<span class=" -Color -Color-Bold">              Metric </span>┃<span class=" -Color -Color-Bold">      Average Score </span>┃<span class=" -Color -Color-Bold"> Passes </span>┃<span class=" -Color -Color-Bold"> Failures </span>┃<span class=" -Color -Color-Bold"> Success Rate </span>┃
┡━━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━╇━━━━━━━━━━╇━━━━━━━━━━━━━━┩
│ Factual Consistency │ 0.9911543130874634 │      <span class=" -Color -Color-Green">1</span> │        <span class=" -Color -Color-Red">0</span> │      100.00% │
│               Total │                  - │      <span class=" -Color -Color-Green">1</span> │        <span class=" -Color -Color-Red">0</span> │      100.00% │
└─────────────────────┴────────────────────┴────────┴──────────┴──────────────┘
</pre></div>
</div>
</div>
</div>
<p><a class="reference external" href="https://github.com/confident-ai/deepeval">Link to DeepEval</a>.</p>
</section>
</section>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            name: "python3",
            path: "./Chapter5"
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

                </article>
              

              
              
              
              
                <footer class="prev-next-footer">
                  <!-- Previous / next buttons -->
<div class="prev-next-area">
    <a class="left-prev"
       href="better_pandas.html"
       title="previous page">
      <i class="fa-solid fa-angle-left"></i>
      <div class="prev-next-info">
        <p class="prev-next-subtitle">previous</p>
        <p class="prev-next-title"><span class="section-number">6.12. </span>Better Pandas</p>
      </div>
    </a>
    <a class="right-next"
       href="SQL.html"
       title="next page">
      <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title"><span class="section-number">6.14. </span>SQL Libraries</p>
      </div>
      <i class="fa-solid fa-angle-right"></i>
    </a>
</div>
                </footer>
              
            </div>
            
            
              
                <div class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">

  <div class="sidebar-secondary-item">
  <div class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> Contents
  </div>
  <nav class="bd-toc-nav page-toc">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#efficiently-resume-work-after-breaks-with-failing-tests">6.13.1. Efficiently Resume Work After Breaks with Failing Tests</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#choose-a-descriptive-name-over-a-short-one-when-naming-your-function">6.13.2. Choose a Descriptive Name Over a Short One When Naming Your Function</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#pytest-benchmark-a-pytest-fixture-to-benchmark-your-code">6.13.3. pytest benchmark: A Pytest Fixture to Benchmark Your Code</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#pytest-mark-parametrize-test-your-functions-with-multiple-inputs">6.13.4. pytest.mark.parametrize: Test Your Functions with Multiple Inputs</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#pytest-parametrize-twice-test-all-possible-combinations-of-two-sets-of-parameters">6.13.5. pytest parametrize twice: Test All Possible Combinations of Two Sets of Parameters</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#assign-ids-to-test-cases">6.13.6. Assign IDs to Test Cases</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#pytest-fixtures-use-the-same-data-for-different-tests">6.13.7. Pytest Fixtures: Use The Same Data for Different Tests</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#execute-a-fixture-only-once-per-session">6.13.8. Execute a Fixture Only Once per Session</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#pytest-skipif-skip-a-test-when-a-condition-is-not-met">6.13.9. Pytest skipif: Skip a Test When a Condition is Not Met</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#pytest-xfail-mark-a-test-as-expected-to-fail">6.13.10. Pytest xfail: Mark a Test as Expected to Fail</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#test-for-specific-exceptions-in-unit-testing">6.13.11. Test for Specific Exceptions in Unit Testing</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#verify-logging-error-with-pytest">6.13.12. Verify Logging Error with pytest</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#pytest-repeat">6.13.13. Pytest repeat</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#pytest-sugar-show-the-failures-and-errors-instantly-with-a-progress-bar">6.13.14. pytest-sugar: Show the Failures and Errors Instantly With a Progress Bar</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#pytest-steps-share-data-between-tests">6.13.15. pytest-steps: Share Data Between Tests</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#pytest-picked-run-the-tests-related-to-the-unstaged-files-in-git">6.13.16. pytest-picked: Run the Tests Related to the Unstaged Files in Git</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#efficient-testing-of-python-class-with-setup-method">6.13.17. Efficient Testing of Python Class with setUp Method</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#freezegun-freeze-dynamic-time-in-unit-testing">6.13.18. FreezeGun: Freeze Dynamic Time in Unit Testing</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#simulate-external-services-in-testing-with-mock-objects">6.13.19. Simulate External Services in Testing with Mock Objects</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#pyfakefs-create-fake-file-system-in-memory-for-testing">6.13.20. pyfakefs: Create Fake File System in Memory for Testing</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#pandera-a-python-library-to-validate-your-pandas-dataframe">6.13.21. Pandera: a Python Library to Validate Your Pandas DataFrame</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#efficiently-generate-falsified-examples-for-unit-tests-with-pandera-and-hypothesis">6.13.22. Efficiently Generate Falsified Examples for Unit Tests with Pandera and Hypothesis</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#deepdiff-find-deep-differences-of-python-objects">6.13.23. DeepDiff Find Deep Differences of Python Objects</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#dirty-equals-write-declarative-assertions-in-your-unit-tests">6.13.24. dirty-equals: Write Declarative Assertions in Your Unit Tests</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#hypothesis-property-based-testing-in-python">6.13.25. hypothesis: Property-based Testing in Python</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#deepchecks-check-category-mismatch-between-train-and-test-set">6.13.26. Deepchecks: Check Category Mismatch Between Train and Test Set</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#check-conflicting-labels-with-deepchecks">6.13.27. Check Conflicting Labels with Deepchecks</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#evaluate-your-ml-model-performance-with-simple-model-comparison">6.13.28. Evaluate Your ML Model Performance with Simple Model Comparison</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#leab-ab-testing-analysis-in-python">6.13.29. leAB: AB Testing Analysis in Python</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#pytest-postgresql-incorporate-database-testing-into-your-pytest-test-suite">6.13.30. pytest-postgresql: Incorporate Database Testing into Your pytest Test Suite</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#maintain-the-accuracy-of-docstring-examples-with-doctest">6.13.31. Maintain the Accuracy of Docstring Examples with Doctest</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#deepeval-unit-testing-for-your-llm-model">6.13.32. DeepEval: Unit Testing for Your LLM Model</a></li>
</ul>
  </nav></div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
<div class="bd-footer-content__inner container">
  
  <div class="footer-item">
    
<p class="component-author">
By Khuyen Tran
</p>

  </div>
  
  <div class="footer-item">
    
  <p class="copyright">
    
      © Copyright 2022.
      <br/>
    
  </p>

  </div>
  
  <div class="footer-item">
    
  </div>
  
  <div class="footer-item">
    
  </div>
  
</div>
          </footer>
        

      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../_static/scripts/bootstrap.js?digest=c5ced968eda925caa686"></script>
<script src="../_static/scripts/pydata-sphinx-theme.js?digest=c5ced968eda925caa686"></script>

  <footer class="bd-footer">
  </footer>
  </body>
</html>